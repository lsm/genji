<!DOCTYPE html><html><head><title>Coverage</title><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style></head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">100</span><a href="#lib/app.js"><span class="dirname">lib/</span><span class="basename">app.js</span></a></li><li><span class="cov high">100</span><a href="#lib/auth.js"><span class="dirname">lib/</span><span class="basename">auth.js</span></a></li><li><span class="cov high">95</span><a href="#lib/context.js"><span class="dirname">lib/</span><span class="basename">context.js</span></a></li><li><span class="cov high">94</span><a href="#lib/control.js"><span class="dirname">lib/</span><span class="basename">control.js</span></a></li><li><span class="cov high">100</span><a href="#lib/cookie.js"><span class="dirname">lib/</span><span class="basename">cookie.js</span></a></li><li><span class="cov high">80</span><a href="#lib/core.js"><span class="dirname">lib/</span><span class="basename">core.js</span></a></li><li><span class="cov high">100</span><a href="#lib/crypto.js"><span class="dirname">lib/</span><span class="basename">crypto.js</span></a></li><li><span class="cov high">100</span><a href="#lib/genji.js"><span class="dirname">lib/</span><span class="basename">genji.js</span></a></li><li><span class="cov high">100</span><a href="#lib/klass.js"><span class="dirname">lib/</span><span class="basename">klass.js</span></a></li><li><span class="cov high">96</span><a href="#lib/model.js"><span class="dirname">lib/</span><span class="basename">model.js</span></a></li><li><span class="cov high">93</span><a href="#lib/plugin/cookie.js"><span class="dirname">lib/plugin/</span><span class="basename">cookie.js</span></a></li><li><span class="cov high">100</span><a href="#lib/plugin/index.js"><span class="dirname">lib/plugin/</span><span class="basename">index.js</span></a></li><li><span class="cov high">100</span><a href="#lib/plugin/parser.js"><span class="dirname">lib/plugin/</span><span class="basename">parser.js</span></a></li><li><span class="cov high">100</span><a href="#lib/plugin/router.js"><span class="dirname">lib/plugin/</span><span class="basename">router.js</span></a></li><li><span class="cov high">93</span><a href="#lib/plugin/securecookie.js"><span class="dirname">lib/plugin/</span><span class="basename">securecookie.js</span></a></li><li><span class="cov high">94</span><a href="#lib/plugin/view.js"><span class="dirname">lib/plugin/</span><span class="basename">view.js</span></a></li><li><span class="cov high">90</span><a href="#lib/router.js"><span class="dirname">lib/</span><span class="basename">router.js</span></a></li><li><span class="cov high">92</span><a href="#lib/site.js"><span class="dirname">lib/</span><span class="basename">site.js</span></a></li><li><span class="cov high">93</span><a href="#lib/util.js"><span class="dirname">lib/</span><span class="basename">util.js</span></a></li><li><span class="cov high">98</span><a href="#lib/view.js"><span class="dirname">lib/</span><span class="basename">view.js</span></a></li><a id="logo" href="http://visionmedia.github.com/mocha/">m</a></div><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">1303</div><div class="hits">1215</div><div class="misses">88</div></div><div id="files"><div class="file"><h2 id="lib/app.js">lib/app.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">49</div><div class="hits">49</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">5</td><td class="hits">1</td><td class="source">var toArray = require('./util').toArray;</td></tr><tr class="hit"> <td class="line">6</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter;</td></tr><tr class="hit"> <td class="line">7</td><td class="hits">1</td><td class="source">var Klass = require('./klass').Klass;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * App constructor function</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">function App() {</td></tr><tr class="hit"> <td class="line">16</td><td class="hits">11</td><td class="source">  EventEmitter.call(this);</td></tr><tr class="hit"> <td class="line">17</td><td class="hits">11</td><td class="source">  var self = this;</td></tr><tr class="hit"> <td class="line">18</td><td class="hits">11</td><td class="source">  self.publicMethods = {};</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">20</td><td class="hits">11</td><td class="source">  for (var k in self) {</td></tr><tr class="hit"> <td class="line">21</td><td class="hits">228</td><td class="source">    if (self.isPublicMethodName(k)) {</td></tr><tr class="hit"> <td class="line">22</td><td class="hits">21</td><td class="source">      this.processPublicMethod(k);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * App prototype object</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">31</td><td class="hits">1</td><td class="source">App.prototype = {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  emitInlineCallback: false,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  prefixDelegatedEvent: true,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  publicMethods: null,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">  reservedMethodNames: Object.keys(EventEmitter.prototype),</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">   * Check if given name can be used as public method name</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">   * @param name {String} Name to check</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   * @returns {boolean}</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  isPublicMethodName: function (name) {</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">228</td><td class="source">    return name &amp;&amp; 'string' === typeof name &amp;&amp; this.reservedMethodNames.indexOf(name) === -1 &amp;&amp; name[0] !== '_';</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">   * The modified emit function which prefixes event with app name if necessary</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">  emit: function () {</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">6</td><td class="source">    var emitter = this.delegate || this;</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">6</td><td class="source">    var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">6</td><td class="source">    if (this.delegate &amp;&amp; this.prefixDelegatedEvent) {</td></tr><tr class="hit"> <td class="line">59</td><td class="hits">3</td><td class="source">      var eventName = 'string' === typeof this.prefixDelegatedEvent ? this.prefixDelegatedEvent : this.name;</td></tr><tr class="hit"> <td class="line">60</td><td class="hits">3</td><td class="source">      eventName += ':' + args[0];</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">3</td><td class="source">      args[0] = this;</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">3</td><td class="source">      args.unshift(eventName);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">64</td><td class="hits">6</td><td class="source">    EventEmitter.prototype.emit.apply(emitter, args);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   * Generate default callback for each public method</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">   * @param propName {String} Name of the property</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  processPublicMethod: function (propName) {</td></tr><tr class="hit"> <td class="line">75</td><td class="hits">21</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">21</td><td class="source">    var f = self[propName];</td></tr><tr class="hit"> <td class="line">77</td><td class="hits">21</td><td class="source">    if ('function' === typeof f) {</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">21</td><td class="source">      self[propName] = self.publicMethods[propName] = (function (name, f) {</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">21</td><td class="source">        return function () {</td></tr><tr class="hit"> <td class="line">80</td><td class="hits">10</td><td class="source">          var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">81</td><td class="hits">10</td><td class="source">          var callback = args[args.length - 1];</td></tr><tr class="hit"> <td class="line">82</td><td class="hits">10</td><td class="source">          var hasCallback = 'function' === typeof callback;</td></tr><tr class="hit"> <td class="line">83</td><td class="hits">10</td><td class="source">          var resultIsNotUndefined = false;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">85</td><td class="hits">10</td><td class="source">          var wrapper = function () {</td></tr><tr class="hit"> <td class="line">86</td><td class="hits">11</td><td class="source">            if (resultIsNotUndefined) {</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">2</td><td class="source">              return;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">9</td><td class="source">            var _args = toArray(arguments);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">91</td><td class="hits">9</td><td class="source">            if (hasCallback) {</td></tr><tr class="hit"> <td class="line">92</td><td class="hits">5</td><td class="source">              if ('before' === self.emitInlineCallback) {</td></tr><tr class="hit"> <td class="line">93</td><td class="hits">1</td><td class="source">                _args.unshift(name);</td></tr><tr class="hit"> <td class="line">94</td><td class="hits">1</td><td class="source">                self.emit.apply(self, _args);</td></tr><tr class="hit"> <td class="line">95</td><td class="hits">1</td><td class="source">                _args.shift();</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">              }</td></tr><tr class="hit"> <td class="line">97</td><td class="hits">5</td><td class="source">              callback.apply(self, _args);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">100</td><td class="hits">9</td><td class="source">            if (!hasCallback || 'after' === self.emitInlineCallback) {</td></tr><tr class="hit"> <td class="line">101</td><td class="hits">5</td><td class="source">              _args.unshift(name);</td></tr><tr class="hit"> <td class="line">102</td><td class="hits">5</td><td class="source">              self.emit.apply(self, _args);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">          };</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">106</td><td class="hits">10</td><td class="source">          if (hasCallback) {</td></tr><tr class="hit"> <td class="line">107</td><td class="hits">5</td><td class="source">            args[args.length - 1] = wrapper;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"> <td class="line">109</td><td class="hits">5</td><td class="source">            args.push(wrapper);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">112</td><td class="hits">10</td><td class="source">          var result = f.apply(self, args);</td></tr><tr class="hit"> <td class="line">113</td><td class="hits">10</td><td class="source">          resultIsNotUndefined = 'undefined' !== typeof result;</td></tr><tr class="hit"> <td class="line">114</td><td class="hits">10</td><td class="source">          return result;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">      })(propName, f);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> * Add more reserved name</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> * @type {Array}</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">127</td><td class="hits">1</td><td class="source">App.prototype.reservedMethodNames = App.prototype.reservedMethodNames.concat(Object.keys(App.prototype), 'init', 'domain', 'name');</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">133</td><td class="hits">1</td><td class="source">exports.App = Klass(EventEmitter, App);</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/auth.js">lib/auth.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">22</div><div class="hits">22</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Secured cookie implementation based on this pubilcation:</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * A Secure Cookie Protocol (http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.92.7649&amp;rep=rep1&amp;type=pdf)</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * More about salted hash, goto:</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * http://phpsec.org/articles/2005/password-hashing.html or http://www.aspheute.com/english/20040105.asp</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * @todo more secured way (e.g. http://gitorious.com/django-password-model)</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var c = require('./crypto'),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    sha1 = c.sha1,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    hmac_sha1 = c.hmac_sha1;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">function sign(username, expiration, data, serverKey) {</td></tr><tr class="hit"> <td class="line">16</td><td class="hits">2</td><td class="source">  var k = hmac_sha1([username, expiration].join(&quot;|&quot;), serverKey);</td></tr><tr class="hit"> <td class="line">17</td><td class="hits">4</td><td class="source">  if (typeof data !== &quot;string&quot;) data = JSON.stringify(data);</td></tr><tr class="hit"> <td class="line">18</td><td class="hits">2</td><td class="source">  var raw = [username, expiration, data].join(&quot;|&quot;);</td></tr><tr class="hit"> <td class="line">19</td><td class="hits">2</td><td class="source">  return raw + &quot;|&quot; + hmac_sha1(raw, k);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">function verify(input, serverKey) {</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">2</td><td class="source">  if (typeof input !== &quot;string&quot;) return false;</td></tr><tr class="hit"> <td class="line">24</td><td class="hits">2</td><td class="source">  var values = input.split(&quot;|&quot;);</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">2</td><td class="source">  if (values.length !== 4) return false;</td></tr><tr class="hit"> <td class="line">26</td><td class="hits">2</td><td class="source">  if (new Date() &gt;= new Date(values[1])) return false;</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">2</td><td class="source">  var k = hmac_sha1([values[0], values[1]].join(&quot;|&quot;), serverKey);</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">2</td><td class="source">  return values.pop().replace(/[\x00-\x20]/g, &quot;&quot;) === hmac_sha1(values.join(&quot;|&quot;), k) ? values : false;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">function checkPassword(password, raw) {</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">3</td><td class="source">  var pass = password.split(&quot;$&quot;);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  // &quot;algo$salt$hash&quot;</td></tr><tr class="hit"> <td class="line">34</td><td class="hits">3</td><td class="source">  if (pass.length === 3) {</td></tr><tr class="hit"> <td class="line">35</td><td class="hits">2</td><td class="source">    if (pass[0] === &quot;sha1&quot;) {</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">2</td><td class="source">      return pass[2] === sha1(pass[1] + raw);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">1</td><td class="source">  return false;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">function makePassword(raw) {</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">1</td><td class="source">  var salt = sha1(&quot;&quot; + Math.random() + Math.random()).slice(0, 9);</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">1</td><td class="source">  return 'sha1$' + salt + &quot;$&quot; + sha1(salt + raw);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">47</td><td class="hits">1</td><td class="source">exports.sign = sign;</td></tr><tr class="hit"> <td class="line">48</td><td class="hits">1</td><td class="source">exports.verify = verify;</td></tr><tr class="hit"> <td class="line">49</td><td class="hits">1</td><td class="source">exports.checkPassword = checkPassword;</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">1</td><td class="source">exports.makePassword = makePassword;</td></tr></tbody></table></div><div class="file"><h2 id="lib/context.js">lib/context.js</h2><div id="stats" class="high"><div class="percentage">95%</div><div class="sloc">46</div><div class="hits">44</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Request/response context for Router and Core</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Klass = require('./klass').Klass;</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter;</td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var extend = require('./util').extend;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * The constructor of context class</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * @param request {http.IncomingMessage}</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * @param response {http.ServerResponse}</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">function Context(request, response) {</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">24</td><td class="source">  EventEmitter.call(this);</td></tr><tr class="hit"> <td class="line">24</td><td class="hits">24</td><td class="source">  this.request = request;</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">24</td><td class="source">  this.response = response;</td></tr><tr class="hit"> <td class="line">26</td><td class="hits">24</td><td class="source">  this.statusCode = 200;</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">24</td><td class="source">  this._headers = {};</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">24</td><td class="source">  this._headerSent = false;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * Context prototype object</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * @type {Object}</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">37</td><td class="hits">1</td><td class="source">Context.prototype = {</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">   * Send a response headers to client</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">   * @param [statusCode] {Number|String} 3-digit HTTP status code, default is 200</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">   * @param [headers] {Object} Optional headers object</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  writeHead: function (statusCode, headers) {</td></tr><tr class="hit"> <td class="line">48</td><td class="hits">8</td><td class="source">    this._headerSent = true;</td></tr><tr class="hit"> <td class="line">49</td><td class="hits">8</td><td class="source">    this.response.writeHead(statusCode || this.statusCode, extend(this._headers, headers));</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">8</td><td class="source">    return this;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">   * Send a chunk of response body to client</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">   * @param chunk {String|Buffer} Data of chunk</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">   * @param [encoding] {String} Encoding string, defaults to 'utf8'</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  write: function (chunk, encoding) {</td></tr><tr class="miss"> <td class="line">62</td><td class="hits">0</td><td class="source">    this.response.write(chunk, encoding);</td></tr><tr class="miss"> <td class="line">63</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">   * Finish the response process with optional data</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">   * @param [data] {String|Buffer} Data to send</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">   * @param [encoding] {String} Encoding string, defaults to 'utf8'</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  end: function (data, encoding) {</td></tr><tr class="hit"> <td class="line">75</td><td class="hits">8</td><td class="source">    if (!this._headerSent) {</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">3</td><td class="source">      this.writeHead(this.statusCode, this._headers);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">8</td><td class="source">    this.response.end(data, encoding);</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">8</td><td class="source">    return this;</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">   * ServerResponse.setHeader</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">   * @param key {String} Key of the header</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">   * @param value {*} Value of the header</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">   * @returns {Object} &quot;this&quot;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">  setHeader: function (key, value) {</td></tr><tr class="hit"> <td class="line">92</td><td class="hits">53</td><td class="source">    this._headers[key] = value;</td></tr><tr class="hit"> <td class="line">93</td><td class="hits">53</td><td class="source">    return this;</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">   * ServerResponse.getHeader</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">   * @param key {String} Key of the header</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">   * @returns {*} Value of the header if any</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">  getHeader: function (key) {</td></tr><tr class="hit"> <td class="line">105</td><td class="hits">48</td><td class="source">    return this._headers[key];</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">   * Check if the given key is setted in header</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">   * @param key {String} Key of the header</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">   * @returns {boolean}</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  hasHeader: function (key) {</td></tr><tr class="hit"> <td class="line">117</td><td class="hits">42</td><td class="source">    return !!this.getHeader(key);</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">   * Add the header if it's not setted</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">   * @param key {String} Key of the header</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">   * @param value {*} Value of the header</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">   * @returns {Object} &quot;this&quot;</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  addHeader: function (key, value) {</td></tr><tr class="hit"> <td class="line">130</td><td class="hits">42</td><td class="source">    if (!this.hasHeader(key)) {</td></tr><tr class="hit"> <td class="line">131</td><td class="hits">29</td><td class="source">      this.setHeader(key, value);</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">133</td><td class="hits">42</td><td class="source">    return this;</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">   * ServerResponse.removeHeader</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">   * @param key {String} Key of the header</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">   * @returns {Object} &quot;this&quot;</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">  removeHeader: function (key) {</td></tr><tr class="hit"> <td class="line">145</td><td class="hits">1</td><td class="source">    delete this._headers[key];</td></tr><tr class="hit"> <td class="line">146</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">   * Set the HTTP status code for response</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">   * @param code {Number|String} 3-digit HTTP status code</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">   * @returns {Object} &quot;this&quot;</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">  setStatusCode: function (code) {</td></tr><tr class="hit"> <td class="line">158</td><td class="hits">3</td><td class="source">    this.statusCode = code;</td></tr><tr class="hit"> <td class="line">159</td><td class="hits">3</td><td class="source">    return this;</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">   * Redirect to given url permanently or not</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">   * @param url {String} Url of redirection</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">   * @param [permanent] {Boolean} Indicate the permanence of the redirection</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">  redirect: function (url, permanent) {</td></tr><tr class="hit"> <td class="line">171</td><td class="hits">2</td><td class="source">    this.setStatusCode(permanent ? 301 : 302);</td></tr><tr class="hit"> <td class="line">172</td><td class="hits">2</td><td class="source">    this.setHeader('Location', url);</td></tr><tr class="hit"> <td class="line">173</td><td class="hits">2</td><td class="source">    this.end();</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">   *  Send response to client in one operation</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">   * @param {String|Object} body Body of the http response</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">   * @param {Number} [code] Http response status code, default `200`</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">   * @param {Object} [headers] Http response headers, default `Content-Type, text/plain;`</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">   * @param {String} [encoding] default 'utf8'</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">  send: function (body, code, headers, encoding) {</td></tr><tr class="hit"> <td class="line">187</td><td class="hits">18</td><td class="source">    if (typeof body !== 'string') {</td></tr><tr class="hit"> <td class="line">188</td><td class="hits">5</td><td class="source">      body = JSON.stringify(body) || &quot;&quot;;</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">190</td><td class="hits">18</td><td class="source">    this.addHeader(&quot;Content-Length&quot;, Buffer.byteLength(body, encoding || 'utf8'));</td></tr><tr class="hit"> <td class="line">191</td><td class="hits">18</td><td class="source">    this.addHeader(&quot;Content-Type&quot;, 'text/plain');</td></tr><tr class="hit"> <td class="line">192</td><td class="hits">18</td><td class="source">    this.writeHead(code, headers);</td></tr><tr class="hit"> <td class="line">193</td><td class="hits">18</td><td class="source">    this.end(body, encoding);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">   * Send data as JSON</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">   * @param data {String|Object} Data as a JSON string or object</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">  sendJSON: function (data) {</td></tr><tr class="hit"> <td class="line">204</td><td class="hits">5</td><td class="source">    this.setHeader('Content-Type', 'application/json; charset=utf-8');</td></tr><tr class="hit"> <td class="line">205</td><td class="hits">5</td><td class="source">    this.send(data);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">   * Send data as HTML text</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">   * @param data {String} String of data</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">  sendHTML: function (data) {</td></tr><tr class="hit"> <td class="line">216</td><td class="hits">7</td><td class="source">    this.setHeader('Content-Type', 'text/html; charset=utf-8');</td></tr><tr class="hit"> <td class="line">217</td><td class="hits">7</td><td class="source">    this.send(data);</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">   * Default error handling function, please override</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">   * @param err {Object|String} Error object</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">  error: function (err) {</td></tr><tr class="hit"> <td class="line">228</td><td class="hits">3</td><td class="source">    var msg = err.message || err.stack;</td></tr><tr class="hit"> <td class="line">229</td><td class="hits">3</td><td class="source">    this.send(msg, err.statusCode || 500);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> * Expose Context class</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source"> * @type {Function}</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">239</td><td class="hits">1</td><td class="source">exports.Context = Klass(EventEmitter, Context);</td></tr></tbody></table></div><div class="file"><h2 id="lib/control.js">lib/control.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">135</div><div class="hits">127</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Utilities for controlling javascript execution flow</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var toArray = require('./util').toArray;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Add functions in named chain and generate a function to call them in the adding order serially</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">17</td><td class="hits">1</td><td class="source">var Chain = function () {</td></tr><tr class="hit"> <td class="line">18</td><td class="hits">16</td><td class="source">  this._chain = {};</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * Chain prototype object</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">25</td><td class="hits">1</td><td class="source">Chain.prototype = {</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   * Add a function to a named chain</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * @param name {String} Name of the chain</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   * @param fn {Function} Function to be added</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">  add: function (name, fn) {</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">44</td><td class="source">    if (!this._chain[name]) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">40</td><td class="source">      this._chain[name] = [];</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">44</td><td class="source">    this._chain[name].push(fn);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">   * Get the chained function</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">   * @param name {String} Name of the chain</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  get: function (name) {</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">41</td><td class="source">    if (this._chain[name]) {</td></tr><tr class="hit"> <td class="line">52</td><td class="hits">40</td><td class="source">      var fnChain = chain(this._chain[name], function (fn, idx, fnChain, next, args) {</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">35</td><td class="source">        args = toArray(args);</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">35</td><td class="source">        args.push(next);</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">35</td><td class="source">        if (fn.apply(this, args)) {</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">2</td><td class="source">          next();</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"> <td class="line">59</td><td class="hits">40</td><td class="source">      return function () {</td></tr><tr class="hit"> <td class="line">60</td><td class="hits">31</td><td class="source">        fnChain(0, toArray(arguments), this);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> * Generate a function which calls each function in array in serial order</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> * @param array {Array} Array of items need to be iterated and called against &quot;callback&quot;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> * @param callback {Function} Callback function for each iteration</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> * @param [doneCallback] Optional finishing callback which will be called at the end of iteration</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> * @returns {Function}</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">function chain(array, callback, doneCallback) {</td></tr><tr class="hit"> <td class="line">77</td><td class="hits">67</td><td class="source">  var length;</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">67</td><td class="source">  if (!Array.isArray(array)) {</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">2</td><td class="source">    if (isFinite(array)) {</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      // can be parsed as a number,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      // this is useful if you want to call one function many times in serial order</td></tr><tr class="hit"> <td class="line">82</td><td class="hits">1</td><td class="source">      length = parseInt(array, 10);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">84</td><td class="hits">1</td><td class="source">      throw new Error('First argument should be either `Array` or `Number`, `' + typeof array + '` got.');</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">65</td><td class="source">    length = array.length;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">66</td><td class="source">  return function next(step, args, ctx) {</td></tr><tr class="hit"> <td class="line">90</td><td class="hits">113</td><td class="source">    step = step || 0;</td></tr><tr class="hit"> <td class="line">91</td><td class="hits">113</td><td class="source">    if (step &gt;= length) {</td></tr><tr class="hit"> <td class="line">92</td><td class="hits">11</td><td class="source">      if (doneCallback) {</td></tr><tr class="hit"> <td class="line">93</td><td class="hits">1</td><td class="source">        doneCallback.call(ctx);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">95</td><td class="hits">11</td><td class="source">      return;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">97</td><td class="hits">102</td><td class="source">    callback.call(ctx, array[step], step++, array, function () {</td></tr><tr class="hit"> <td class="line">98</td><td class="hits">63</td><td class="source">      next(step, arguments.length &gt; 0 ? toArray(arguments) : args, ctx);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    }, args);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> * Executes async function `callback` for data sets `array` in parallel</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> * @param array {Array}</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> * @param callback {Function}</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> * @param doneCallback {Function}</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> * @param context {Object}</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> * @returns {Object}</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">function parallel(array, callback, doneCallback, context) {</td></tr><tr class="hit"> <td class="line">115</td><td class="hits">4</td><td class="source">  var count = 0, len = array.length, result = [];</td></tr><tr class="hit"> <td class="line">116</td><td class="hits">4</td><td class="source">  var failCallback;</td></tr><tr class="hit"> <td class="line">117</td><td class="hits">4</td><td class="source">  var timer, timeoutSeconds, timeoutCallback;</td></tr><tr class="hit"> <td class="line">118</td><td class="hits">4</td><td class="source">  process.nextTick(function () {</td></tr><tr class="hit"> <td class="line">119</td><td class="hits">4</td><td class="source">    array.forEach(function (item, idx, arr) {</td></tr><tr class="hit"> <td class="line">120</td><td class="hits">13</td><td class="source">      callback.call(context, item, idx, arr, function (err, res) {</td></tr><tr class="hit"> <td class="line">121</td><td class="hits">12</td><td class="source">        ++count;</td></tr><tr class="hit"> <td class="line">122</td><td class="hits">12</td><td class="source">        if (timer &amp;&amp; count === len) {</td></tr><tr class="miss"> <td class="line">123</td><td class="hits">0</td><td class="source">          clearTimeout(timer);</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">125</td><td class="hits">12</td><td class="source">        if (err) {</td></tr><tr class="hit"> <td class="line">126</td><td class="hits">1</td><td class="source">          if (failCallback) {</td></tr><tr class="hit"> <td class="line">127</td><td class="hits">1</td><td class="source">            failCallback.call(context, err, item, idx);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="miss"> <td class="line">129</td><td class="hits">0</td><td class="source">            console.trace('Please set error handling function with `.fail`');</td></tr><tr class="miss"> <td class="line">130</td><td class="hits">0</td><td class="source">            throw err;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"> <td class="line">133</td><td class="hits">11</td><td class="source">          result[idx] = res;</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">135</td><td class="hits">12</td><td class="source">        if (count === len) {</td></tr><tr class="hit"> <td class="line">136</td><td class="hits">3</td><td class="source">          if (doneCallback) {</td></tr><tr class="hit"> <td class="line">137</td><td class="hits">3</td><td class="source">            doneCallback.call(context, result);</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">142</td><td class="hits">4</td><td class="source">    if (timeoutSeconds) {</td></tr><tr class="hit"> <td class="line">143</td><td class="hits">1</td><td class="source">      timer = setTimeout(function () {</td></tr><tr class="hit"> <td class="line">144</td><td class="hits">1</td><td class="source">        timeoutCallback.call(context, result);</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">      }, timeoutSeconds * 1000);</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"> <td class="line">148</td><td class="hits">4</td><td class="source">  var ret = {</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    done: function (callback) {</td></tr><tr class="hit"> <td class="line">150</td><td class="hits">3</td><td class="source">      doneCallback = callback;</td></tr><tr class="hit"> <td class="line">151</td><td class="hits">3</td><td class="source">      return ret;</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    fail: function (callback) {</td></tr><tr class="hit"> <td class="line">154</td><td class="hits">1</td><td class="source">      failCallback = callback;</td></tr><tr class="hit"> <td class="line">155</td><td class="hits">1</td><td class="source">      return ret;</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    timeout: function (callback, timeoutInSeconds) {</td></tr><tr class="hit"> <td class="line">158</td><td class="hits">1</td><td class="source">      timeoutSeconds = timeoutInSeconds;</td></tr><tr class="hit"> <td class="line">159</td><td class="hits">1</td><td class="source">      timeoutCallback = callback;</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">  };</td></tr><tr class="hit"> <td class="line">162</td><td class="hits">4</td><td class="source">  return ret;</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> * Simple function which can convert your async function to promise style and call as many times as you wish</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> * @param {Function} asyncFn Your original async function like `fs.readFile`</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> * @param {Object} context Context you want to keep for the asyncFn (`this` inside your function scope)</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> * @returns {Function} Promise version of your function,</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> * which you can register the callback functions by calling `then(callback)` of the returned object</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">function promise(asyncFn, context) {</td></tr><tr class="hit"> <td class="line">176</td><td class="hits">1</td><td class="source">  return function () {</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    // the callback registered by calling `when(callback)`</td></tr><tr class="hit"> <td class="line">178</td><td class="hits">1</td><td class="source">    var callback;</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">    // we assume last argument of the original function is its callback</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    // and you should omit this argument for the promised function generated</td></tr><tr class="hit"> <td class="line">181</td><td class="hits">1</td><td class="source">    var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">182</td><td class="hits">1</td><td class="source">    args.push(function () {</td></tr><tr class="hit"> <td class="line">183</td><td class="hits">1</td><td class="source">      if (callback) {</td></tr><tr class="hit"> <td class="line">184</td><td class="hits">1</td><td class="source">        callback.apply(context, arguments);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    // call the original async function with given context in next tick</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    // to make sure the `when` function set the callback first</td></tr><tr class="hit"> <td class="line">189</td><td class="hits">1</td><td class="source">    process.nextTick(function () {</td></tr><tr class="hit"> <td class="line">190</td><td class="hits">1</td><td class="source">      asyncFn.apply(context, args);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">192</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">      when: function (handleFunc) {</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">        // register the callback function</td></tr><tr class="hit"> <td class="line">195</td><td class="hits">1</td><td class="source">        callback = handleFunc;</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> * This an extended version of previous `promise` function with error handling and flow control facilities</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> * @param {Function} asyncFn Your original async function like `fs.readFile`</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> * @param {Object} context Context you want to keep for the asyncFn (`this` inside your function scope)</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> * @param {Object} emitter Event emitter (delegate) use to emit and listen events</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> * @returns {Function} Deferred version of your function,</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> * which you can register the callback functions by calling `then(callback)` of the returned object</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> * and set the error handling function by calling `fail(errback)` respectively</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">function defer(asyncFn, context, emitter) {</td></tr><tr class="hit"> <td class="line">212</td><td class="hits">4</td><td class="source">  return function () {</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    // the callback handler(s) registered by calling `then(callback)`</td></tr><tr class="hit"> <td class="line">214</td><td class="hits">6</td><td class="source">    var thenCallbacks = [], failCallbacks = [], andCallbacks = [], doneCallback, callback, nextDeferred;</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    // we assume last argument of the original function is its callback</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">    // and you should omit this argument for the deferred function generated</td></tr><tr class="hit"> <td class="line">217</td><td class="hits">6</td><td class="source">    var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">218</td><td class="hits">6</td><td class="source">    args.push(function (err) {</td></tr><tr class="hit"> <td class="line">219</td><td class="hits">6</td><td class="source">      if (nextDeferred || callback) {</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">        // `callback` and `nextDeferred` should accept `err` as argument</td></tr><tr class="hit"> <td class="line">221</td><td class="hits">2</td><td class="source">        andCallbacks.push(function (defer) {</td></tr><tr class="hit"> <td class="line">222</td><td class="hits">2</td><td class="source">          var _args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">223</td><td class="hits">2</td><td class="source">          _args[0] = err;</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">          // call the `callback` first if any</td></tr><tr class="hit"> <td class="line">225</td><td class="hits">2</td><td class="source">          if (callback) {</td></tr><tr class="hit"> <td class="line">226</td><td class="hits">1</td><td class="source">            callback.apply(this, _args);</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">228</td><td class="hits">2</td><td class="source">          if (nextDeferred) {</td></tr><tr class="hit"> <td class="line">229</td><td class="hits">1</td><td class="source">            if (err) {</td></tr><tr class="miss"> <td class="line">230</td><td class="hits">0</td><td class="source">              nextDeferred.error(err);</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"> <td class="line">232</td><td class="hits">1</td><td class="source">              nextDeferred.next.apply(this, _args.slice(1));</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">      // this assume that, the first argument of the callback is an error object if error occurs, otherwise should be `null`</td></tr><tr class="hit"> <td class="line">238</td><td class="hits">6</td><td class="source">      if (!err) {</td></tr><tr class="hit"> <td class="line">239</td><td class="hits">5</td><td class="source">        var theArgs = toArray(arguments);</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">        // since there is no `err`, remove it from the arguments</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">        // this can help you separate your error handling logic from business logic</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">        // and make the error handling part reusable</td></tr><tr class="hit"> <td class="line">243</td><td class="hits">5</td><td class="source">        theArgs.shift();</td></tr><tr class="hit"> <td class="line">244</td><td class="hits">5</td><td class="source">        if (thenCallbacks.length &gt; 0) {</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">          // call the `then` stack</td></tr><tr class="hit"> <td class="line">246</td><td class="hits">2</td><td class="source">          thenCallbacks.forEach(function (fn) {</td></tr><tr class="hit"> <td class="line">247</td><td class="hits">3</td><td class="source">            fn.apply(context, theArgs);</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">250</td><td class="hits">5</td><td class="source">        if (andCallbacks.length &gt; 0) {</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">          // call the `and` stack</td></tr><tr class="hit"> <td class="line">252</td><td class="hits">5</td><td class="source">          chain(andCallbacks, function (fn, idx, fnChains, next, chainArgs) {</td></tr><tr class="hit"> <td class="line">253</td><td class="hits">16</td><td class="source">            chainArgs.unshift({next: next, error: errback_});</td></tr><tr class="hit"> <td class="line">254</td><td class="hits">16</td><td class="source">            if (fn.apply(this, chainArgs)) {</td></tr><tr class="hit"> <td class="line">255</td><td class="hits">4</td><td class="source">              chainArgs.shift();</td></tr><tr class="hit"> <td class="line">256</td><td class="hits">4</td><td class="source">              next.apply(null, chainArgs);</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">          }, doneCallback || (emitter &amp;&amp; function () {</td></tr><tr class="miss"> <td class="line">259</td><td class="hits">0</td><td class="source">            emitter.emit('done');</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">          }))(0, theArgs, context);</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">263</td><td class="hits">1</td><td class="source">        errback_(err);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">      // define an error callback so that we can call it in the `and` chain</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">      function errback_(err) {</td></tr><tr class="hit"> <td class="line">267</td><td class="hits">1</td><td class="source">        if (failCallbacks.length &gt; 0 || emitter) {</td></tr><tr class="hit"> <td class="line">268</td><td class="hits">1</td><td class="source">          if (emitter) {</td></tr><tr class="hit"> <td class="line">269</td><td class="hits">1</td><td class="source">            emitter.emit('fail', err);</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">          // if we have error handler then use it</td></tr><tr class="hit"> <td class="line">272</td><td class="hits">1</td><td class="source">          failCallbacks.forEach(function (fn) {</td></tr><tr class="hit"> <td class="line">273</td><td class="hits">1</td><td class="source">            fn.call(context, err);</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">          // otherwise throw the exception</td></tr><tr class="miss"> <td class="line">277</td><td class="hits">0</td><td class="source">          console.trace('Please set error handling function with `.fail` or supply an `emitter` and listen to the `fail` event.');</td></tr><tr class="miss"> <td class="line">278</td><td class="hits">0</td><td class="source">          throw err;</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">    // call the original async function with given context in next tick</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">    // to make sure the `then`,`and`,`done`,`fail` function set the callback first</td></tr><tr class="hit"> <td class="line">284</td><td class="hits">6</td><td class="source">    process.nextTick(function () {</td></tr><tr class="hit"> <td class="line">285</td><td class="hits">6</td><td class="source">      asyncFn.apply(context, args);</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">287</td><td class="hits">6</td><td class="source">    var ret = {</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">      then: function () {</td></tr><tr class="hit"> <td class="line">289</td><td class="hits">6</td><td class="source">        var fns = toArray(arguments);</td></tr><tr class="hit"> <td class="line">290</td><td class="hits">6</td><td class="source">        if (andCallbacks.length &gt; 0) {</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">          // put at the tail of `and` callbacks</td></tr><tr class="hit"> <td class="line">292</td><td class="hits">3</td><td class="source">          var fn = function () {</td></tr><tr class="hit"> <td class="line">293</td><td class="hits">3</td><td class="source">            var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">294</td><td class="hits">3</td><td class="source">            args.shift(); // shift the `defer` object</td></tr><tr class="hit"> <td class="line">295</td><td class="hits">3</td><td class="source">            fns.forEach(function (f) {</td></tr><tr class="hit"> <td class="line">296</td><td class="hits">4</td><td class="source">              f.apply(this, args);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">            }, this);</td></tr><tr class="hit"> <td class="line">298</td><td class="hits">3</td><td class="source">            return true;</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">          };</td></tr><tr class="hit"> <td class="line">300</td><td class="hits">3</td><td class="source">          andCallbacks.push(fn);</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">          // register the callback function in parallel</td></tr><tr class="hit"> <td class="line">303</td><td class="hits">3</td><td class="source">          thenCallbacks = thenCallbacks.concat(fns);</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">305</td><td class="hits">6</td><td class="source">        return ret;</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">      and: function () {</td></tr><tr class="hit"> <td class="line">308</td><td class="hits">10</td><td class="source">        andCallbacks = andCallbacks.concat(toArray(arguments));</td></tr><tr class="hit"> <td class="line">309</td><td class="hits">10</td><td class="source">        return ret;</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">      callback: function (cb) {</td></tr><tr class="hit"> <td class="line">312</td><td class="hits">1</td><td class="source">        callback = cb;</td></tr><tr class="hit"> <td class="line">313</td><td class="hits">1</td><td class="source">        return ret;</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">      defer: function (deferred) {</td></tr><tr class="hit"> <td class="line">316</td><td class="hits">1</td><td class="source">        nextDeferred = deferred;</td></tr><tr class="hit"> <td class="line">317</td><td class="hits">1</td><td class="source">        return ret;</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">      done: function (fn) {</td></tr><tr class="hit"> <td class="line">320</td><td class="hits">1</td><td class="source">        doneCallback = emitter ? function () {</td></tr><tr class="hit"> <td class="line">321</td><td class="hits">1</td><td class="source">          emitter.emit('done');</td></tr><tr class="hit"> <td class="line">322</td><td class="hits">1</td><td class="source">          fn.call(this);</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">        } : fn;</td></tr><tr class="hit"> <td class="line">324</td><td class="hits">1</td><td class="source">        return ret;</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">      fail: function (errorFunc, replace) {</td></tr><tr class="hit"> <td class="line">327</td><td class="hits">1</td><td class="source">        if (replace) {</td></tr><tr class="miss"> <td class="line">328</td><td class="hits">0</td><td class="source">          failCallbacks = [errorFunc];</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"> <td class="line">330</td><td class="hits">1</td><td class="source">          failCallbacks.push(errorFunc);</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">332</td><td class="hits">1</td><td class="source">        return ret;</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"> <td class="line">335</td><td class="hits">6</td><td class="source">    if (emitter) {</td></tr><tr class="hit"> <td class="line">336</td><td class="hits">2</td><td class="source">      ret.emitter = emitter;</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">338</td><td class="hits">6</td><td class="source">    return ret;</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">346</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">  chain: chain,</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">  parallel: parallel,</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">  Chain: Chain,</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">  promise: promise,</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">  defer: defer</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/cookie.js">lib/cookie.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">26</div><div class="hits">26</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Cookie parsing/encoding utilities</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var qs = require('querystring');</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var escape = qs.escape;</td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var unescape = qs.unescape;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * @type {{parse: Function, stringify: Function, checkLength: Function}}</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">19</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   * Parse a cookie string</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">   * @param cookie {String} The cookie string being parsed</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">   * @param [name] {String} If the name is given, it returns cookie value for this name</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">   * @returns {Object|String}</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  parse: function (cookie, name) {</td></tr><tr class="hit"> <td class="line">31</td><td class="hits">5</td><td class="source">    var cookies = {};</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">5</td><td class="source">    if ('string' === typeof cookie) {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">      // Copied from: [cookie-sessions](http://github.com/caolan/cookie-sessions/blob/master/lib/cookie-sessions.js)</td></tr><tr class="hit"> <td class="line">34</td><td class="hits">5</td><td class="source">      cookies = cookie.split(/\s*;\s*/g).map(</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        function (x) {</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">15</td><td class="source">          return x.split('=');</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        }).reduce(function (a, x) {</td></tr><tr class="hit"> <td class="line">38</td><td class="hits">15</td><td class="source">          if (x[0] &amp;&amp; x[1]) {</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">13</td><td class="source">            a[unescape(x[0])] = unescape(x[1]);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">15</td><td class="source">          return a;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        }, {});</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">5</td><td class="source">    return name ? cookies[name] : cookies;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   * Encode cookie into string</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">   * @param name {String} Cookie name</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">   * @param value {String} Cookie value</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">   * @param options {Object} Cookie options</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">   * @returns {string}</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">  stringify: function (name, value, options) {</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">4</td><td class="source">    var cookie = name + &quot;=&quot; + escape(value);</td></tr><tr class="hit"> <td class="line">59</td><td class="hits">4</td><td class="source">    if (options) {</td></tr><tr class="hit"> <td class="line">60</td><td class="hits">4</td><td class="source">      if (options.expires) {</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">4</td><td class="source">        cookie += &quot;; expires=&quot; + options.expires.toUTCString();</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">63</td><td class="hits">4</td><td class="source">      if (options.path) {</td></tr><tr class="hit"> <td class="line">64</td><td class="hits">3</td><td class="source">        cookie += &quot;; path=&quot; + options.path;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">4</td><td class="source">      if (options.domain) {</td></tr><tr class="hit"> <td class="line">67</td><td class="hits">2</td><td class="source">        cookie += &quot;; domain=&quot; + options.domain;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">69</td><td class="hits">4</td><td class="source">      if (options.secure) {</td></tr><tr class="hit"> <td class="line">70</td><td class="hits">1</td><td class="source">        cookie += &quot;; secure=&quot; + options.secure;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">72</td><td class="hits">4</td><td class="source">      if (options.httponly) {</td></tr><tr class="hit"> <td class="line">73</td><td class="hits">1</td><td class="source">        cookie += &quot;; httponly=&quot; + options.httponly;</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">75</td><td class="hits">4</td><td class="source">      return cookie;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">   * Check if the length of cookie string is conform to standard</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">   * @param cookieStr {String} Cookie string</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">   * @returns {boolean}</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  checkLength: function (cookieStr) {</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">1</td><td class="source">    return cookieStr.length &lt;= 4096;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/core.js">lib/core.js</h2><div id="stats" class="high"><div class="percentage">80%</div><div class="sloc">194</div><div class="hits">157</div><div class="misses">37</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Middleware system inspired by Connect</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Klass = require('./klass').Klass;</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var Chain = require('./control').Chain;</td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter;</td></tr><tr class="hit"> <td class="line">12</td><td class="hits">1</td><td class="source">var Path = require('path');</td></tr><tr class="hit"> <td class="line">13</td><td class="hits">1</td><td class="source">var toArray = require('./util').toArray;</td></tr><tr class="hit"> <td class="line">14</td><td class="hits">1</td><td class="source">var App = require('./app').App;</td></tr><tr class="hit"> <td class="line">15</td><td class="hits">1</td><td class="source">var Context = require('./context').Context;</td></tr><tr class="hit"> <td class="line">16</td><td class="hits">1</td><td class="source">var extend = require('./util').extend;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * The middleware management class</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @param [site] {Object} Optional Site instance object</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">26</td><td class="hits">1</td><td class="source">var Core = Klass(Chain, {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   * Constructor class</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   * @param [site] {Object} Optional Site instance object</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">   * @constructor</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  init: function (site) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">14</td><td class="source">    this.site = site;</td></tr><tr class="hit"> <td class="line">38</td><td class="hits">14</td><td class="source">    this.plugins = [];</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">14</td><td class="source">    this.stackNames = [];</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">14</td><td class="source">    this.stacks = {};</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">14</td><td class="source">    this.apps = {};</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">14</td><td class="source">    this.routes = {};</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">   * Get the &quot;writeHead&quot; functions chain</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  writeHead: function () {</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">13</td><td class="source">    this.add('writeHead', function (statusCode, headers) {</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">15</td><td class="source">      this.response.writeHead(statusCode, headers);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    // return the stacked callbacks</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">13</td><td class="source">    return this.get('writeHead');</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">   * Get the &quot;write&quot; functions chain</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  write: function () {</td></tr><tr class="hit"> <td class="line">68</td><td class="hits">13</td><td class="source">    this.add('write', function (chunk, encoding) {</td></tr><tr class="miss"> <td class="line">69</td><td class="hits">0</td><td class="source">      if (!this._headerSent) {</td></tr><tr class="miss"> <td class="line">70</td><td class="hits">0</td><td class="source">        this.writeHead();</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"> <td class="line">72</td><td class="hits">0</td><td class="source">      this.response.write(chunk, encoding);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">74</td><td class="hits">13</td><td class="source">    return this.get('write');</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">   * Get the &quot;end&quot; functions chain</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">  end: function () {</td></tr><tr class="hit"> <td class="line">85</td><td class="hits">13</td><td class="source">    this.add('end', function (chunk, encoding) {</td></tr><tr class="hit"> <td class="line">86</td><td class="hits">15</td><td class="source">      if (!this._headerSent) {</td></tr><tr class="miss"> <td class="line">87</td><td class="hits">0</td><td class="source">        this.writeHead();</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">15</td><td class="source">      this.response.end(chunk, encoding);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">91</td><td class="hits">13</td><td class="source">    return this.get('end');</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">   * Load a plugin and push to stack or extend as module</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">   * @param plugin {String|Object} The name string of the built-in plugin or the plugin object</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">   * @param [options] {Object} Optional plugin options</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">  use: function (plugin, options) {</td></tr><tr class="hit"> <td class="line">103</td><td class="hits">26</td><td class="source">    if ('string' === typeof plugin) {</td></tr><tr class="hit"> <td class="line">104</td><td class="hits">24</td><td class="source">      plugin = require(Path.join(__dirname, '/plugin', plugin.toLowerCase()));</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">107</td><td class="hits">26</td><td class="source">    var pluginName = plugin.name;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">109</td><td class="hits">26</td><td class="source">    if (this.plugins.indexOf(pluginName) &gt; -1) {</td></tr><tr class="miss"> <td class="line">110</td><td class="hits">0</td><td class="source">      throw new Error('Duplicated plugin name: ' + pluginName);</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">113</td><td class="hits">26</td><td class="source">    this.plugins.push(pluginName);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">115</td><td class="hits">26</td><td class="source">    if (plugin.attach) {</td></tr><tr class="hit"> <td class="line">116</td><td class="hits">25</td><td class="source">      var fn = plugin.attach(this, options);</td></tr><tr class="hit"> <td class="line">117</td><td class="hits">25</td><td class="source">      if ('function' === typeof fn) {</td></tr><tr class="hit"> <td class="line">118</td><td class="hits">23</td><td class="source">        this.stackNames.push(pluginName);</td></tr><tr class="hit"> <td class="line">119</td><td class="hits">23</td><td class="source">        this.stacks[pluginName] = fn;</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">123</td><td class="hits">26</td><td class="source">    if (plugin.module) {</td></tr><tr class="hit"> <td class="line">124</td><td class="hits">3</td><td class="source">      Context = Context(plugin.module);</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">126</td><td class="hits">26</td><td class="source">    return this;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">   * @param app</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  load: function (app) {</td></tr><tr class="hit"> <td class="line">135</td><td class="hits">3</td><td class="source">    this.apps[app.name.toLowerCase()] = app;</td></tr><tr class="hit"> <td class="line">136</td><td class="hits">3</td><td class="source">    return this;</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">   * @param routes</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">   * @returns {*}</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">  map: function (routes) {</td></tr><tr class="hit"> <td class="line">146</td><td class="hits">13</td><td class="source">    extend(this.routes, routes);</td></tr><tr class="hit"> <td class="line">147</td><td class="hits">13</td><td class="source">    return this;</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">   * Map methods of app to routes and add normalized routes to router</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">  buildRoutes: function () {</td></tr><tr class="hit"> <td class="line">157</td><td class="hits">13</td><td class="source">    if (!this.router) {</td></tr><tr class="hit"> <td class="line">158</td><td class="hits">4</td><td class="source">      this.use('router');</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">161</td><td class="hits">13</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">162</td><td class="hits">13</td><td class="source">    var router = this.router;</td></tr><tr class="hit"> <td class="line">163</td><td class="hits">13</td><td class="source">    var routes = this.routes;</td></tr><tr class="hit"> <td class="line">164</td><td class="hits">13</td><td class="source">    var apps = this.apps;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">166</td><td class="hits">13</td><td class="source">    Object.keys(apps).forEach(function (appName) {</td></tr><tr class="hit"> <td class="line">167</td><td class="hits">3</td><td class="source">      var _app = apps[appName];</td></tr><tr class="hit"> <td class="line">168</td><td class="hits">3</td><td class="source">      var publicMethods = _app.publicMethods;</td></tr><tr class="hit"> <td class="line">169</td><td class="hits">3</td><td class="source">      Object.keys(publicMethods).forEach(function (name) {</td></tr><tr class="hit"> <td class="line">170</td><td class="hits">3</td><td class="source">        var routeName = appName + name[0].toUpperCase() + name.slice(1);</td></tr><tr class="hit"> <td class="line">171</td><td class="hits">3</td><td class="source">        var route = self.normalizeRoute(routeName, routes, apps);</td></tr><tr class="hit"> <td class="line">172</td><td class="hits">3</td><td class="source">        if (route) {</td></tr><tr class="hit"> <td class="line">173</td><td class="hits">3</td><td class="source">          router.add(route.method, route.url, route.handler, route.hooks);</td></tr><tr class="hit"> <td class="line">174</td><td class="hits">3</td><td class="source">          delete routes[route.name];</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">179</td><td class="hits">13</td><td class="source">    Object.keys(routes).forEach(function (routeName) {</td></tr><tr class="hit"> <td class="line">180</td><td class="hits">12</td><td class="source">      var route = self.normalizeRoute(routeName, routes, apps);</td></tr><tr class="hit"> <td class="line">181</td><td class="hits">12</td><td class="source">      if (route) {</td></tr><tr class="hit"> <td class="line">182</td><td class="hits">11</td><td class="source">        router.add(route.method, route.url, route.handler, route.hooks);</td></tr><tr class="hit"> <td class="line">183</td><td class="hits">11</td><td class="source">        delete routes[route.name];</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">   * Normalize route and generate default settings based on route name, app or provided routes</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">   * @param routeName {String} Name of the route, if app supplied this should be name of the app function</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">   * @param routes {Object} The routes definition object</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">   * @param [apps] {Object} Optional object of app instances</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">   * @returns {Object|Boolean}</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">  normalizeRoute: function (routeName, routes, apps) {</td></tr><tr class="hit"> <td class="line">199</td><td class="hits">15</td><td class="source">    var router = this.router;</td></tr><tr class="hit"> <td class="line">200</td><td class="hits">15</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">201</td><td class="hits">15</td><td class="source">    var defaultViewPath = router.slashCamelCase(routeName);</td></tr><tr class="hit"> <td class="line">202</td><td class="hits">15</td><td class="source">    var appName = defaultViewPath.split('/')[0];</td></tr><tr class="hit"> <td class="line">203</td><td class="hits">15</td><td class="source">    if (routeName === appName) {</td></tr><tr class="hit"> <td class="line">204</td><td class="hits">1</td><td class="source">      return false;</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">207</td><td class="hits">14</td><td class="source">    var app;</td></tr><tr class="hit"> <td class="line">208</td><td class="hits">14</td><td class="source">    var appFn;</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">210</td><td class="hits">14</td><td class="source">    if (apps) {</td></tr><tr class="hit"> <td class="line">211</td><td class="hits">14</td><td class="source">      app = apps[appName];</td></tr><tr class="hit"> <td class="line">212</td><td class="hits">14</td><td class="source">      if (app) {</td></tr><tr class="hit"> <td class="line">213</td><td class="hits">3</td><td class="source">        var methodName = routeName.replace(appName, '');</td></tr><tr class="hit"> <td class="line">214</td><td class="hits">3</td><td class="source">        methodName = methodName[0].toLowerCase() + methodName.slice(1);</td></tr><tr class="hit"> <td class="line">215</td><td class="hits">3</td><td class="source">        appFn = app.publicMethods[methodName];</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">219</td><td class="hits">14</td><td class="source">    var route = routes[routeName] || {};</td></tr><tr class="hit"> <td class="line">220</td><td class="hits">14</td><td class="source">    route.name = routeName;</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">222</td><td class="hits">14</td><td class="source">    defaultViewPath = defaultViewPath.split('/');</td></tr><tr class="hit"> <td class="line">223</td><td class="hits">14</td><td class="source">    defaultViewPath.shift();</td></tr><tr class="hit"> <td class="line">224</td><td class="hits">14</td><td class="source">    defaultViewPath = appName + '/' + defaultViewPath.join('_');</td></tr><tr class="hit"> <td class="line">225</td><td class="hits">14</td><td class="source">    defaultViewPath += '.html';</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">227</td><td class="hits">14</td><td class="source">    var appRouteDefaults = routes[appName] || {};</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">229</td><td class="hits">14</td><td class="source">    if (!route.method) {</td></tr><tr class="hit"> <td class="line">230</td><td class="hits">4</td><td class="source">      route.method = appRouteDefaults.method || 'GET';</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">233</td><td class="hits">14</td><td class="source">    if (!route.url) {</td></tr><tr class="hit"> <td class="line">234</td><td class="hits">4</td><td class="source">      route.url = router.slashCamelCase(routeName);</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">237</td><td class="hits">14</td><td class="source">    if (appRouteDefaults.urlRoot &amp;&amp; route.url[0] !== '^') {</td></tr><tr class="miss"> <td class="line">238</td><td class="hits">0</td><td class="source">      route.url = route.url.split('/');</td></tr><tr class="miss"> <td class="line">239</td><td class="hits">0</td><td class="source">      route.url.shift();</td></tr><tr class="miss"> <td class="line">240</td><td class="hits">0</td><td class="source">      route.url = router.prefixUrl(appRouteDefaults.urlRoot, route.url.join('/'));</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">243</td><td class="hits">14</td><td class="source">    if (!route.view) {</td></tr><tr class="hit"> <td class="line">244</td><td class="hits">9</td><td class="source">      if (self.view) {</td></tr><tr class="miss"> <td class="line">245</td><td class="hits">0</td><td class="source">        route.view = defaultViewPath;</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">247</td><td class="hits">9</td><td class="source">        route.view = 'html';</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">251</td><td class="hits">14</td><td class="source">    switch (route.view) {</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">      case 'html':</td></tr><tr class="hit"> <td class="line">253</td><td class="hits">9</td><td class="source">        route.view = function (err, result) {</td></tr><tr class="hit"> <td class="line">254</td><td class="hits">2</td><td class="source">          if (err) {</td></tr><tr class="miss"> <td class="line">255</td><td class="hits">0</td><td class="source">            this.error(err);</td></tr><tr class="miss"> <td class="line">256</td><td class="hits">0</td><td class="source">            return;</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">258</td><td class="hits">2</td><td class="source">          this.sendHTML(result || '');</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"> <td class="line">260</td><td class="hits">9</td><td class="source">        break;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">      case 'json':</td></tr><tr class="hit"> <td class="line">262</td><td class="hits">1</td><td class="source">        route.view = function (err, result) {</td></tr><tr class="hit"> <td class="line">263</td><td class="hits">1</td><td class="source">          if (err) {</td></tr><tr class="miss"> <td class="line">264</td><td class="hits">0</td><td class="source">            this.error(err);</td></tr><tr class="miss"> <td class="line">265</td><td class="hits">0</td><td class="source">            return;</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">267</td><td class="hits">1</td><td class="source">          this.sendJSON(result || '{}');</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"> <td class="line">269</td><td class="hits">1</td><td class="source">        break;</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">272</td><td class="hits">14</td><td class="source">    if (self.view &amp;&amp; 'string' === typeof route.view) {</td></tr><tr class="miss"> <td class="line">273</td><td class="hits">0</td><td class="source">      defaultViewPath = route.view;</td></tr><tr class="miss"> <td class="line">274</td><td class="hits">0</td><td class="source">      route.view = function (err, result) {</td></tr><tr class="miss"> <td class="line">275</td><td class="hits">0</td><td class="source">        if (err) {</td></tr><tr class="miss"> <td class="line">276</td><td class="hits">0</td><td class="source">          this.error(err);</td></tr><tr class="miss"> <td class="line">277</td><td class="hits">0</td><td class="source">          return;</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"> <td class="line">279</td><td class="hits">0</td><td class="source">        this.render(result);</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">283</td><td class="hits">14</td><td class="source">    if (!route.handler) {</td></tr><tr class="hit"> <td class="line">284</td><td class="hits">7</td><td class="source">      if (app &amp;&amp; appFn) {</td></tr><tr class="hit"> <td class="line">285</td><td class="hits">3</td><td class="source">        route.handler = function (context) {</td></tr><tr class="hit"> <td class="line">286</td><td class="hits">3</td><td class="source">          var next;</td></tr><tr class="hit"> <td class="line">287</td><td class="hits">3</td><td class="source">          var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">288</td><td class="hits">3</td><td class="source">          context.app = app;</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">          function callback() {</td></tr><tr class="hit"> <td class="line">291</td><td class="hits">3</td><td class="source">            if (self.view) {</td></tr><tr class="miss"> <td class="line">292</td><td class="hits">0</td><td class="source">              context.view = self.view;</td></tr><tr class="miss"> <td class="line">293</td><td class="hits">0</td><td class="source">              context.viewPath = defaultViewPath;</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"> <td class="line">295</td><td class="hits">3</td><td class="source">            route.view.apply(context, arguments);</td></tr><tr class="hit"> <td class="line">296</td><td class="hits">3</td><td class="source">            if (next) {</td></tr><tr class="hit"> <td class="line">297</td><td class="hits">1</td><td class="source">              next();</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">301</td><td class="hits">3</td><td class="source">          if (context.session) {</td></tr><tr class="hit"> <td class="line">302</td><td class="hits">1</td><td class="source">            args[0] = context.session;</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"> <td class="line">304</td><td class="hits">2</td><td class="source">            args.shift();</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">307</td><td class="hits">3</td><td class="source">          if ('function' === typeof args[args.length - 1]) {</td></tr><tr class="hit"> <td class="line">308</td><td class="hits">1</td><td class="source">            next = args.pop();</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">311</td><td class="hits">3</td><td class="source">          args.push(callback);</td></tr><tr class="hit"> <td class="line">312</td><td class="hits">3</td><td class="source">          appFn.apply(app, args);</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">315</td><td class="hits">4</td><td class="source">        route.handler = function (context) {</td></tr><tr class="hit"> <td class="line">316</td><td class="hits">4</td><td class="source">          if (app) {</td></tr><tr class="miss"> <td class="line">317</td><td class="hits">0</td><td class="source">            context.app = app;</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">319</td><td class="hits">4</td><td class="source">          if (self.view) {</td></tr><tr class="hit"> <td class="line">320</td><td class="hits">4</td><td class="source">            context.view = self.view;</td></tr><tr class="hit"> <td class="line">321</td><td class="hits">4</td><td class="source">            context.viewPath = defaultViewPath;</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">323</td><td class="hits">4</td><td class="source">          var args = toArray(arguments);</td></tr><tr class="hit"> <td class="line">324</td><td class="hits">4</td><td class="source">          args[0] = null;</td></tr><tr class="hit"> <td class="line">325</td><td class="hits">4</td><td class="source">          route.view.apply(context, args);</td></tr><tr class="hit"> <td class="line">326</td><td class="hits">4</td><td class="source">          return true;</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">329</td><td class="hits">7</td><td class="source">    } else if (app) {</td></tr><tr class="miss"> <td class="line">330</td><td class="hits">0</td><td class="source">      var handler = route.handler;</td></tr><tr class="miss"> <td class="line">331</td><td class="hits">0</td><td class="source">      route.handler = function (context) {</td></tr><tr class="miss"> <td class="line">332</td><td class="hits">0</td><td class="source">        context.app = app;</td></tr><tr class="miss"> <td class="line">333</td><td class="hits">0</td><td class="source">        handler.apply(null, arguments);</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">337</td><td class="hits">14</td><td class="source">    if (appRouteDefaults &amp;&amp; appRouteDefaults.hooks) {</td></tr><tr class="hit"> <td class="line">338</td><td class="hits">1</td><td class="source">      if (route.hooks) {</td></tr><tr class="miss"> <td class="line">339</td><td class="hits">0</td><td class="source">        route.hooks = router.stackHook(appRouteDefaults.hooks, route.hooks);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">341</td><td class="hits">1</td><td class="source">        route.hooks = appRouteDefaults.hooks.slice(0);</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">345</td><td class="hits">14</td><td class="source">    return route;</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">   * Get the listener which can handle &quot;request&quot; event</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">  getListener: function () {</td></tr><tr class="hit"> <td class="line">356</td><td class="hits">13</td><td class="source">    this.buildRoutes();</td></tr><tr class="hit"> <td class="line">357</td><td class="hits">13</td><td class="source">    var stacks = this.stacks;</td></tr><tr class="hit"> <td class="line">358</td><td class="hits">13</td><td class="source">    var stackNames = this.stackNames;</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">    function go(idx, ctx, request, response, where, jumping) {</td></tr><tr class="hit"> <td class="line">361</td><td class="hits">36</td><td class="source">      var curr;</td></tr><tr class="hit"> <td class="line">362</td><td class="hits">36</td><td class="source">      if ('undefined' === typeof where) {</td></tr><tr class="hit"> <td class="line">363</td><td class="hits">36</td><td class="source">        curr = stacks[stackNames[idx++]];</td></tr><tr class="hit"> <td class="line">364</td><td class="hits">36</td><td class="source">        if (!curr) {</td></tr><tr class="hit"> <td class="line">365</td><td class="hits">13</td><td class="source">          return;</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"> <td class="line">368</td><td class="hits">0</td><td class="source">        var whereIdx = stackNames.indexOf(where);</td></tr><tr class="miss"> <td class="line">369</td><td class="hits">0</td><td class="source">        if (whereIdx &gt; -1) {</td></tr><tr class="miss"> <td class="line">370</td><td class="hits">0</td><td class="source">          curr = stacks[where];</td></tr><tr class="miss"> <td class="line">371</td><td class="hits">0</td><td class="source">          if (jumping) {</td></tr><tr class="miss"> <td class="line">372</td><td class="hits">0</td><td class="source">            idx = whereIdx + 1;</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"> <td class="line">375</td><td class="hits">0</td><td class="source">          throw new Error('Undefined plugin: ' + where);</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">379</td><td class="hits">23</td><td class="source">      curr.call(ctx, request, response, function (where, jumping) {</td></tr><tr class="hit"> <td class="line">380</td><td class="hits">20</td><td class="source">        go(idx, ctx, request, response, where, jumping);</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">384</td><td class="hits">13</td><td class="source">    var writeHead = this.writeHead();</td></tr><tr class="hit"> <td class="line">385</td><td class="hits">13</td><td class="source">    var write = this.write();</td></tr><tr class="hit"> <td class="line">386</td><td class="hits">13</td><td class="source">    var end = this.end();</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">388</td><td class="hits">13</td><td class="source">    Context = Context({</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">      writeHead: function (statusCode, headers) {</td></tr><tr class="hit"> <td class="line">390</td><td class="hits">15</td><td class="source">        this._headerSent = true;</td></tr><tr class="hit"> <td class="line">391</td><td class="hits">15</td><td class="source">        writeHead.call(this, statusCode || this.statusCode, extend(this._headers, headers));</td></tr><tr class="hit"> <td class="line">392</td><td class="hits">15</td><td class="source">        return this;</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">      write: function (chunk, encoding) {</td></tr><tr class="miss"> <td class="line">395</td><td class="hits">0</td><td class="source">        write.call(this, chunk, encoding);</td></tr><tr class="miss"> <td class="line">396</td><td class="hits">0</td><td class="source">        return this;</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">      end: function (chunk, encoding) {</td></tr><tr class="hit"> <td class="line">399</td><td class="hits">15</td><td class="source">        end.call(this, chunk, encoding);</td></tr><tr class="hit"> <td class="line">400</td><td class="hits">15</td><td class="source">        return this;</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">404</td><td class="hits">13</td><td class="source">    if (this.site) {</td></tr><tr class="hit"> <td class="line">405</td><td class="hits">4</td><td class="source">      var site = this.site;</td></tr><tr class="hit"> <td class="line">406</td><td class="hits">4</td><td class="source">      Context = Context({</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">        set: function () {</td></tr><tr class="miss"> <td class="line">408</td><td class="hits">0</td><td class="source">          return site.set.apply(site, arguments);</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">        get: function () {</td></tr><tr class="miss"> <td class="line">411</td><td class="hits">0</td><td class="source">          return site.get.apply(site, arguments);</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">416</td><td class="hits">13</td><td class="source">    return function (request, response) {</td></tr><tr class="hit"> <td class="line">417</td><td class="hits">16</td><td class="source">      var ctx = new Context(request, response);</td></tr><tr class="hit"> <td class="line">418</td><td class="hits">16</td><td class="source">      go(0, ctx, request, response);</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">});</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source"> * Expose Core</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source"> * @type {Function}</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">429</td><td class="hits">1</td><td class="source">exports.Core = Core;</td></tr></tbody></table></div><div class="file"><h2 id="lib/crypto.js">lib/crypto.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">33</div><div class="hits">33</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Some shortcuts for crypto</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"> <td class="line">8</td><td class="hits">1</td><td class="source">var crypto = require('crypto');</td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var fs = require('fs');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">function _hashFile(alg, path, encoding, callback) {</td></tr><tr class="hit"> <td class="line">12</td><td class="hits">4</td><td class="source">  if (typeof encoding === 'function') {</td></tr><tr class="hit"> <td class="line">13</td><td class="hits">2</td><td class="source">    callback = encoding;</td></tr><tr class="hit"> <td class="line">14</td><td class="hits">2</td><td class="source">    encoding = undefined;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">16</td><td class="hits">4</td><td class="source">  var stream = fs.createReadStream(path);</td></tr><tr class="hit"> <td class="line">17</td><td class="hits">4</td><td class="source">  var hash = crypto.createHash(alg);</td></tr><tr class="hit"> <td class="line">18</td><td class="hits">4</td><td class="source">  stream.on('data',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">      function(chunk) {</td></tr><tr class="hit"> <td class="line">20</td><td class="hits">3</td><td class="source">        hash.update(chunk);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      }).on('end',</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">      function() {</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">3</td><td class="source">        callback(null, hash.digest(encoding || 'hex'));</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      }).on('error', function(err) {</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">1</td><td class="source">        callback(err);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">29</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  md5: function (data, encoding) {</td></tr><tr class="hit"> <td class="line">31</td><td class="hits">2</td><td class="source">    return crypto.createHash('md5').update(data).digest(encoding || 'hex');</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  md5file: function(path, encoding, callback) {</td></tr><tr class="hit"> <td class="line">35</td><td class="hits">2</td><td class="source">    _hashFile('md5', path, encoding, callback);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  sha1: function(data, encoding) {</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">5</td><td class="source">    return crypto.createHash('sha1').update(data).digest(encoding || 'hex');</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  sha1file: function(path, encoding, callback) {</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">2</td><td class="source">    _hashFile('sha1', path, encoding, callback);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  hmac: function(algo, data, key, encoding) {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">9</td><td class="source">    return crypto.createHmac(algo, key).update(data).digest(encoding || 'hex');</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  hmac_sha1: function(data, key, encoding) {</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">9</td><td class="source">    return module.exports.hmac('sha1', data, key, encoding);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  cipher: function(plain, key, options) {</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">2</td><td class="source">    options = options || {};</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">2</td><td class="source">    var oe = options.outputEncoding || 'hex';</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">2</td><td class="source">    var c = crypto.createCipher(options.algorithm || 'aes256', key);</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">2</td><td class="source">    return c.update(plain, options.inputEncoding || 'utf8', oe) + c.final(oe);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  decipher: function(cipher, key, options) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">2</td><td class="source">    options = options || {};</td></tr><tr class="hit"> <td class="line">63</td><td class="hits">2</td><td class="source">    var oe = options.outputEncoding || 'utf8';</td></tr><tr class="hit"> <td class="line">64</td><td class="hits">2</td><td class="source">    var d = crypto.createDecipher(options.algorithm || 'aes256', key);</td></tr><tr class="hit"> <td class="line">65</td><td class="hits">2</td><td class="source">    var result = '';</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">2</td><td class="source">    try {</td></tr><tr class="hit"> <td class="line">67</td><td class="hits">2</td><td class="source">      result = d.update(cipher, options.inputEncoding || 'hex', oe) + d.final(oe);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    } catch (e) {}</td></tr><tr class="hit"> <td class="line">69</td><td class="hits">2</td><td class="source">    return result;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  base64Encode: function(input, inputEncoding) {</td></tr><tr class="hit"> <td class="line">73</td><td class="hits">1</td><td class="source">    var buf = new Buffer(input, inputEncoding || 'utf8');</td></tr><tr class="hit"> <td class="line">74</td><td class="hits">1</td><td class="source">    return buf.toString('base64');</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">  base64Decode: function(input, outputEncoding) {</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">1</td><td class="source">    var base64 = new Buffer(input, 'base64');</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">1</td><td class="source">    return base64.toString(outputEncoding || 'utf8');</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/genji.js">lib/genji.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">23</div><div class="hits">23</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * The global Genji module</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Exposes version of Genji</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * @type {string}</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">exports.version = exports.VERSION = '0.7.0';</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * Exposes public apis and modules</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">17</td><td class="hits">1</td><td class="source">var util = require('./util');</td></tr><tr class="hit"> <td class="line">18</td><td class="hits">1</td><td class="source">var extend = util.extend;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * Extends frequently used sub-modules to the global Genji module</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">24</td><td class="hits">1</td><td class="source">extend(exports, util);</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">1</td><td class="source">extend(exports, require('./klass'));</td></tr><tr class="hit"> <td class="line">26</td><td class="hits">1</td><td class="source">extend(exports, require('./control'));</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">1</td><td class="source">extend(exports, require('./core'));</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">1</td><td class="source">extend(exports, require('./context'));</td></tr><tr class="hit"> <td class="line">29</td><td class="hits">1</td><td class="source">extend(exports, require('./site'));</td></tr><tr class="hit"> <td class="line">30</td><td class="hits">1</td><td class="source">extend(exports, require('./router'));</td></tr><tr class="hit"> <td class="line">31</td><td class="hits">1</td><td class="source">extend(exports, require('./model'));</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">1</td><td class="source">extend(exports, require('./app'));</td></tr><tr class="hit"> <td class="line">33</td><td class="hits">1</td><td class="source">extend(exports, {View: require('./view').View});</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * Extends other sub-modules with module name as namespace</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">39</td><td class="hits">1</td><td class="source">extend(exports, {auth: require('./auth')});</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">1</td><td class="source">extend(exports, {cookie: require('./cookie')});</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">1</td><td class="source">extend(exports, {crypto: require('./crypto')});</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">1</td><td class="source">extend(exports, {view: require('./view')});</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">1</td><td class="source">extend(exports, {plugin: require('./plugin')});</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> * Creates a Router instance</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> * @param [routes] {Array} Optional predefined routing definitions</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> * @param [options] {Object} Optional router options which may contains:</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> *   - contextClass Default context constructor class</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> *   - urlRoot The default url prefix</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> * @returns {exports.Router} The router instance</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">55</td><td class="hits">1</td><td class="source">exports.route = function route(routes, options) {</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">9</td><td class="source">  options = options || {};</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">9</td><td class="source">  return new exports.Router(routes, options);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> * Creates a Site instance</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> * @returns {exports.Site}</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">66</td><td class="hits">1</td><td class="source">exports.site = function site() {</td></tr><tr class="hit"> <td class="line">67</td><td class="hits">4</td><td class="source">  return new exports.Site();</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/klass.js">lib/klass.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">21</div><div class="hits">21</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Javascript OO helpers</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module exports.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">exports.Klass = Klass;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Super lightweight javascript OO implementation</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @param superClass {Function} The parent class which you want to inherit from</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @param subModule {Object} Instance properties of subclass</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * @param [inherit] {Function} Optional customized inheriting function for changing the default inheriting behaviour</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * @return {Function} The inherited subclass</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">function Klass(superClass, subModule, inherit) {</td></tr><tr class="hit"> <td class="line">22</td><td class="hits">37</td><td class="source">  var global = this;</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">37</td><td class="source">  var superCtor = superClass;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">25</td><td class="hits">37</td><td class="source">  if ('function' === typeof subModule) {</td></tr><tr class="hit"> <td class="line">26</td><td class="hits">4</td><td class="source">    superCtor = subModule;</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">4</td><td class="source">    subModule = subModule.prototype;</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">30</td><td class="hits">37</td><td class="source">  var _inherit = function (prototype, subModule) {</td></tr><tr class="hit"> <td class="line">31</td><td class="hits">34</td><td class="source">    Object.keys(subModule).forEach(function (key) {</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">114</td><td class="source">      prototype[key] = subModule[key];</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">36</td><td class="hits">37</td><td class="source">  if (inherit) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">32</td><td class="source">    _inherit = inherit;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  function constructor(subModule, inherit) {</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">265</td><td class="source">    if (global !== this) {</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">234</td><td class="source">      superCtor.apply(this, arguments);</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">234</td><td class="source">      if ('function' === typeof this.init) {</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">37</td><td class="source">        this.init.apply(this, arguments);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">31</td><td class="source">      return Klass(constructor, subModule, inherit || _inherit);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">51</td><td class="hits">37</td><td class="source">  var prototype = constructor.prototype;</td></tr><tr class="hit"> <td class="line">52</td><td class="hits">37</td><td class="source">  prototype.__proto__ = superClass.prototype;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">54</td><td class="hits">37</td><td class="source">  if (subModule) {</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">36</td><td class="source">    _inherit(prototype, subModule);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">58</td><td class="hits">37</td><td class="source">  return constructor;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/model.js">lib/model.js</h2><div id="stats" class="high"><div class="percentage">96%</div><div class="sloc">121</div><div class="hits">117</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Database agnostic data model class</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"> <td class="line">8</td><td class="hits">1</td><td class="source">var Klass = require('./klass').Klass;</td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var extend = require('./util').extend;</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var util = require('util');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * Constructor function of Model</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @param data {Object} Data that need to be handled by Model</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">function Model(data) {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  // mark that we are initializing, changed fields should not be recorded.</td></tr><tr class="hit"> <td class="line">21</td><td class="hits">4</td><td class="source">  this.initialized = false;</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  // tell if the input data has `idAttribute` or not. (default `idAttribute` field is `_id`)</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">4</td><td class="source">  this.noIdAttribute = !data[this.idAttribute];</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  // object to hold the document data</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">4</td><td class="source">  this.data = {};</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  // object contains the invaild fields and values and reasons</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">4</td><td class="source">  this.invalidFields = {count: 0, fields: {}};</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">4</td><td class="source">  this.setters = this.setters || {};</td></tr><tr class="hit"> <td class="line">29</td><td class="hits">4</td><td class="source">  this.getters = this.getters || {};</td></tr><tr class="hit"> <td class="line">30</td><td class="hits">4</td><td class="source">  this.aliases = this.aliases || {};</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  // object contains the changed field/value pairs</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">4</td><td class="source">  this.changedFields = false;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  // check for required fields</td></tr><tr class="hit"> <td class="line">35</td><td class="hits">4</td><td class="source">  var self = this;</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">4</td><td class="source">  if (Array.isArray(this.requires) &amp;&amp; this.requires.length &gt; 0) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">3</td><td class="source">    this.requires.forEach(function (fieldName) {</td></tr><tr class="hit"> <td class="line">38</td><td class="hits">6</td><td class="source">      if (!data.hasOwnProperty(fieldName)) {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        // missing field found</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">1</td><td class="source">        self.invalidFields.count++;</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">1</td><td class="source">        self.invalidFields.fields[fieldName] = {error: this.ERROR_FIELD_MISSING};</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  // set input data to internal `this.data` object, apply validators and setters.</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">4</td><td class="source">  Object.keys(data).forEach(function (key) {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">19</td><td class="source">    self.set(key, data[key]);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  // mark that the initialization is finished</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">4</td><td class="source">  this.initialized = true;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> * Model prototype object</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">57</td><td class="hits">1</td><td class="source">Model.prototype = {</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">   * Name of the Model</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  name: 'Model',</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  idAttribute: '_id',</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">   * Data field setter function.</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   * @param key {String} Name of the field</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">   * @param value {*} Value of the field</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">   * @returns {*} &quot;this&quot;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  set: function (key, value) {</td></tr><tr class="hit"> <td class="line">75</td><td class="hits">21</td><td class="source">    var isInvalid = this.validateField(key, value);</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">21</td><td class="source">    if (isInvalid) {</td></tr><tr class="hit"> <td class="line">77</td><td class="hits">3</td><td class="source">      this.invalidFields.count++;</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">3</td><td class="source">      this.invalidFields.fields[key] = {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        error: isInvalid === true ? this.ERROR_FIELD_INVALID : isInvalid,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        value: value</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">83</td><td class="hits">18</td><td class="source">      var data = this.data;</td></tr><tr class="hit"> <td class="line">84</td><td class="hits">18</td><td class="source">      var aliasKey = this.aliases[key] || key;</td></tr><tr class="hit"> <td class="line">85</td><td class="hits">18</td><td class="source">      if (this.getInvalidFields().hasOwnProperty(key)) {</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        // if this field is invalid previously, then delete the field from invalidFields hash.</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">1</td><td class="source">        this.invalidFields.count--;</td></tr><tr class="hit"> <td class="line">88</td><td class="hits">1</td><td class="source">        delete this.invalidFields.fields[key];</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">      // get setter function from setters hash</td></tr><tr class="hit"> <td class="line">91</td><td class="hits">18</td><td class="source">      var setter = this.setters[key];</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      // apply attribute's setter function if any, when original data doc has no `_idAttribute`</td></tr><tr class="hit"> <td class="line">93</td><td class="hits">18</td><td class="source">      var newValue = this.noIdAttribute &amp;&amp; setter ? setter.call(this, value) : value;</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      // save the changed value if we're not initializing.</td></tr><tr class="hit"> <td class="line">95</td><td class="hits">18</td><td class="source">      if (this.initialized &amp;&amp; data[aliasKey] !== newValue) {</td></tr><tr class="hit"> <td class="line">96</td><td class="hits">2</td><td class="source">        this.changedFields = this.changedFields || {};</td></tr><tr class="hit"> <td class="line">97</td><td class="hits">2</td><td class="source">        this.changedFields[key] = newValue;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">99</td><td class="hits">18</td><td class="source">      data[aliasKey] = newValue;</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">101</td><td class="hits">21</td><td class="source">    return this;</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">   * Get field value by name.</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">   * @param key {String|Array} Name of the field or array of field names</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">   * @returns {*} Field value or field/value hash if key is Array</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">  get: function (key) {</td></tr><tr class="hit"> <td class="line">113</td><td class="hits">18</td><td class="source">    if (Array.isArray(key)) {</td></tr><tr class="hit"> <td class="line">114</td><td class="hits">1</td><td class="source">      var obj = {};</td></tr><tr class="hit"> <td class="line">115</td><td class="hits">1</td><td class="source">      key.forEach(function (keyName) {</td></tr><tr class="hit"> <td class="line">116</td><td class="hits">2</td><td class="source">        obj[keyName] = this.get(keyName);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">      }, this);</td></tr><tr class="hit"> <td class="line">118</td><td class="hits">1</td><td class="source">      return obj;</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">120</td><td class="hits">17</td><td class="source">    var data = this.data;</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    // use original key name</td></tr><tr class="hit"> <td class="line">122</td><td class="hits">17</td><td class="source">    var aliasKey = this.aliases[key] || key;</td></tr><tr class="hit"> <td class="line">123</td><td class="hits">17</td><td class="source">    var getter = this.getters[key];</td></tr><tr class="hit"> <td class="line">124</td><td class="hits">17</td><td class="source">    return getter ? getter.call(this, data[aliasKey]) : data[aliasKey];</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">   * Validate field base on the &quot;this.fields&quot; object.</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">   * @param fieldName {String} Name of the field</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">   * @param value {*} Value that need to be validated</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">   * @returns {Boolean|*} Returns &quot;false&quot; if validated successfully otherwise returns error code</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">  validateField: function (fieldName, value) {</td></tr><tr class="hit"> <td class="line">136</td><td class="hits">21</td><td class="source">    if (!this.fields) {</td></tr><tr class="miss"> <td class="line">137</td><td class="hits">0</td><td class="source">      return false;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">140</td><td class="hits">21</td><td class="source">    var field = this.maps[fieldName] || fieldName;</td></tr><tr class="hit"> <td class="line">141</td><td class="hits">21</td><td class="source">    var validator = this.fields[field];</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">143</td><td class="hits">21</td><td class="source">    if (!validator) {</td></tr><tr class="miss"> <td class="line">144</td><td class="hits">0</td><td class="source">      return false;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">147</td><td class="hits">21</td><td class="source">    var validatorType = typeof validator;</td></tr><tr class="hit"> <td class="line">148</td><td class="hits">21</td><td class="source">    if ('string' === validatorType) {</td></tr><tr class="hit"> <td class="line">149</td><td class="hits">12</td><td class="source">      switch (validator) {</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        case 'number':</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        case 'string':</td></tr><tr class="hit"> <td class="line">152</td><td class="hits">7</td><td class="source">          return validator === typeof value ? false : this.ERROR_FIELD_TYPE;</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        case 'array':</td></tr><tr class="hit"> <td class="line">154</td><td class="hits">1</td><td class="source">          return Array.isArray(value) ? false : this.ERROR_FIELD_TYPE;</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        case 'regexp':</td></tr><tr class="hit"> <td class="line">156</td><td class="hits">1</td><td class="source">          return util.isRegExp(value) ? false : this.ERROR_FIELD_TYPE;</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">        case 'date':</td></tr><tr class="hit"> <td class="line">158</td><td class="hits">1</td><td class="source">          return util.isDate(value) ? false : this.ERROR_FIELD_TYPE;</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        case 'bool':</td></tr><tr class="hit"> <td class="line">160</td><td class="hits">2</td><td class="source">          return value === true || value === false ? false : this.ERROR_FIELD_TYPE;</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">162</td><td class="hits">9</td><td class="source">    } else if (validatorType === 'function') {</td></tr><tr class="hit"> <td class="line">163</td><td class="hits">8</td><td class="source">      return validator(value);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">165</td><td class="hits">1</td><td class="source">    return this.ERROR_VALIDATOR;</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">   * Check if current data in model is valid or not.</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">   * @returns {Boolean}</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">  isValid: function () {</td></tr><tr class="hit"> <td class="line">176</td><td class="hits">8</td><td class="source">    return this.invalidFields.count === 0;</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">   * Get invalid data fields</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">   * @returns {Boolean|Object} False if all fields are valid otherwise object.</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">  getInvalidFields: function () {</td></tr><tr class="hit"> <td class="line">187</td><td class="hits">19</td><td class="source">    return this.invalidFields.count === 0 ? false : this.invalidFields.fields;</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">   * Get the changed fields after model initialized.</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">   * @returns {*}</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">  changed: function () {</td></tr><tr class="hit"> <td class="line">198</td><td class="hits">1</td><td class="source">    return this.changedFields;</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">   * Return data with fields' name that you want to present to end-user.</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">   * @param [keys] {Array} Array of fields you want to get, if not supplied return all fields.</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">   * @returns {Object|Boolean} False if model has invalid field</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">  toData: function (keys) {</td></tr><tr class="hit"> <td class="line">210</td><td class="hits">2</td><td class="source">    if (!this.isValid()) {</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">      // return false if we have invalid field</td></tr><tr class="hit"> <td class="line">212</td><td class="hits">1</td><td class="source">      return false;</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">214</td><td class="hits">1</td><td class="source">    var _data = this.data;</td></tr><tr class="hit"> <td class="line">215</td><td class="hits">1</td><td class="source">    var data = {};</td></tr><tr class="hit"> <td class="line">216</td><td class="hits">1</td><td class="source">    keys = keys || Object.keys(_data);</td></tr><tr class="hit"> <td class="line">217</td><td class="hits">1</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">218</td><td class="hits">1</td><td class="source">    var _maps = this.maps;</td></tr><tr class="hit"> <td class="line">219</td><td class="hits">1</td><td class="source">    keys.forEach(function (key) {</td></tr><tr class="hit"> <td class="line">220</td><td class="hits">3</td><td class="source">      data[_maps[key] || key] = self.get(_maps[key] || key);</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">222</td><td class="hits">1</td><td class="source">    return data;</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">   * Return data with fields' name that you want to save to database.</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">   * @param [keys] {Array} Array of fields you want to get, if not supplied return all fields.</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">   * @returns {Object|Boolean} False if model has invalid field</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">  toDoc: function (keys) {</td></tr><tr class="hit"> <td class="line">234</td><td class="hits">3</td><td class="source">    if (!this.isValid()) {</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">      // return false if we have invalid field</td></tr><tr class="hit"> <td class="line">236</td><td class="hits">1</td><td class="source">      return false;</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">238</td><td class="hits">2</td><td class="source">    var _data = this.data;</td></tr><tr class="hit"> <td class="line">239</td><td class="hits">2</td><td class="source">    var doc = {};</td></tr><tr class="hit"> <td class="line">240</td><td class="hits">2</td><td class="source">    keys = keys || Object.keys(_data);</td></tr><tr class="hit"> <td class="line">241</td><td class="hits">2</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">242</td><td class="hits">2</td><td class="source">    var _aliases = this.aliases;</td></tr><tr class="hit"> <td class="line">243</td><td class="hits">2</td><td class="source">    var _maps = this.maps;</td></tr><tr class="hit"> <td class="line">244</td><td class="hits">2</td><td class="source">    keys.forEach(function (key) {</td></tr><tr class="hit"> <td class="line">245</td><td class="hits">7</td><td class="source">      doc[_aliases[key] || key] = self.get(_maps[key] || key);</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">247</td><td class="hits">2</td><td class="source">    return doc;</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">   * Error codes.</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">  ERROR_FIELD_MISSING: 1001,</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">  ERROR_FIELD_TYPE: 1002,</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">  ERROR_FIELD_INVALID: 1003,</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">  ERROR_VALIDATOR: 1004</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> * Model inherits function</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> * @param prototype {Object} Prototype object of parent class</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> * @param subModule {Object}</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> * @private</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">function modelInherits(prototype, subModule) {</td></tr><tr class="hit"> <td class="line">269</td><td class="hits">2</td><td class="source">  Object.keys(subModule).forEach(function (propKey) {</td></tr><tr class="hit"> <td class="line">270</td><td class="hits">11</td><td class="source">    var notReserved = false;</td></tr><tr class="hit"> <td class="line">271</td><td class="hits">11</td><td class="source">    switch (propKey) {</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">      case 'name':</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">      case 'requires':</td></tr><tr class="hit"> <td class="line">274</td><td class="hits">3</td><td class="source">        prototype[propKey] = subModule[propKey];</td></tr><tr class="hit"> <td class="line">275</td><td class="hits">3</td><td class="source">        break;</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">      case 'fields':</td></tr><tr class="hit"> <td class="line">277</td><td class="hits">2</td><td class="source">        prototype.fields = extend({}, prototype.fields, subModule.fields);</td></tr><tr class="hit"> <td class="line">278</td><td class="hits">2</td><td class="source">        break;</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">      case 'aliases':</td></tr><tr class="hit"> <td class="line">280</td><td class="hits">2</td><td class="source">        var aliases = extend({}, prototype.aliases, subModule.aliases);</td></tr><tr class="hit"> <td class="line">281</td><td class="hits">2</td><td class="source">        var maps = {};</td></tr><tr class="hit"> <td class="line">282</td><td class="hits">2</td><td class="source">        Object.keys(aliases).forEach(function (alias) {</td></tr><tr class="hit"> <td class="line">283</td><td class="hits">3</td><td class="source">          maps[aliases[alias]] = alias;</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"> <td class="line">285</td><td class="hits">2</td><td class="source">        prototype.aliases = aliases;</td></tr><tr class="hit"> <td class="line">286</td><td class="hits">2</td><td class="source">        prototype.maps = maps;</td></tr><tr class="hit"> <td class="line">287</td><td class="hits">2</td><td class="source">        break;</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">      case 'id':</td></tr><tr class="miss"> <td class="line">289</td><td class="hits">0</td><td class="source">        prototype.idAttribute = subModule.id;</td></tr><tr class="miss"> <td class="line">290</td><td class="hits">0</td><td class="source">        break;</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">      default:</td></tr><tr class="hit"> <td class="line">292</td><td class="hits">4</td><td class="source">        notReserved = true;</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">294</td><td class="hits">11</td><td class="source">    if (notReserved) {</td></tr><tr class="hit"> <td class="line">295</td><td class="hits">4</td><td class="source">      if (/^(set|get)[A-Z]+/.test(propKey)) {</td></tr><tr class="hit"> <td class="line">296</td><td class="hits">2</td><td class="source">        var attributeName = propKey.slice(3);</td></tr><tr class="hit"> <td class="line">297</td><td class="hits">2</td><td class="source">        attributeName = attributeName[0].toLowerCase() + attributeName.slice(1);</td></tr><tr class="hit"> <td class="line">298</td><td class="hits">2</td><td class="source">        if (prototype.fields &amp;&amp; prototype.fields.hasOwnProperty(attributeName)) {</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">          // field is defined, this should be a setter/getter for attribute</td></tr><tr class="hit"> <td class="line">300</td><td class="hits">2</td><td class="source">          var fn = subModule[propKey];</td></tr><tr class="hit"> <td class="line">301</td><td class="hits">2</td><td class="source">          if (typeof fn === 'function') {</td></tr><tr class="hit"> <td class="line">302</td><td class="hits">2</td><td class="source">            switch (propKey.slice(0, 3)) {</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">              case 'set':</td></tr><tr class="hit"> <td class="line">304</td><td class="hits">1</td><td class="source">                prototype.setters = prototype.setters || {};</td></tr><tr class="hit"> <td class="line">305</td><td class="hits">1</td><td class="source">                prototype.setters[attributeName] = fn;</td></tr><tr class="hit"> <td class="line">306</td><td class="hits">1</td><td class="source">                break;</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">              case 'get':</td></tr><tr class="hit"> <td class="line">308</td><td class="hits">1</td><td class="source">                prototype.getters = prototype.getters || {};</td></tr><tr class="hit"> <td class="line">309</td><td class="hits">1</td><td class="source">                prototype.getters[attributeName] = fn;</td></tr><tr class="hit"> <td class="line">310</td><td class="hits">1</td><td class="source">                break;</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">313</td><td class="hits">2</td><td class="source">          return;</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">316</td><td class="hits">2</td><td class="source">      prototype[propKey] = subModule[propKey];</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">325</td><td class="hits">1</td><td class="source">exports.Model = Klass(Model, null, modelInherits);</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/cookie.js">lib/plugin/cookie.js</h2><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">16</div><div class="hits">15</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Cookie module plugin for context</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var cookie = require('../cookie');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @type {{name: String, module: Object}}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">18</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * Name of the plugin</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  name: &quot;Cookie&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   * Cookie module object</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  module: {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * Set cookie to response header</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * @param name {String} Name of the cookie</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * @param value {*} Value of the cookie</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">     * @param options {Object} Options of the cookie</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">     * @public</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    setCookie: function (name, value, options) {</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">3</td><td class="source">      var cookieString = cookie.stringify(name, value, options);</td></tr><tr class="hit"> <td class="line">45</td><td class="hits">3</td><td class="source">      var cookies = this.getHeader('Set-Cookie');</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">3</td><td class="source">      if (!Array.isArray(cookies)) {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">2</td><td class="source">        cookies = [];</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">49</td><td class="hits">3</td><td class="source">      cookies.push(cookieString);</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">3</td><td class="source">      this.setHeader('Set-Cookie', cookies);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">     * Get request cookie value</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">     * @param name {String} Name of the cookie</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">     * @returns {*} Value of the cookie if found</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">     * @public</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    getCookie: function (name) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">1</td><td class="source">      if (!this.request.headers.cookie) {</td></tr><tr class="miss"> <td class="line">63</td><td class="hits">0</td><td class="source">        return null;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">65</td><td class="hits">1</td><td class="source">      if (!this.cookies) { // request cookie will be parsed only one time</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">1</td><td class="source">        this.cookies = cookie.parse(this.request.headers.cookie);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">68</td><td class="hits">1</td><td class="source">      return this.cookies[name];</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">     * Set a clear cookie to response header</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">     * @param name {String} Name of the cookie need to be cleared</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">     * @param options {Object} Options of the cookie</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    clearCookie: function (name, options) {</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">1</td><td class="source">      options = options || {};</td></tr><tr class="hit"> <td class="line">80</td><td class="hits">1</td><td class="source">      options.expires = new Date(0);</td></tr><tr class="hit"> <td class="line">81</td><td class="hits">1</td><td class="source">      this.setCookie(name, &quot;&quot;, options);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/index.js">lib/plugin/index.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">1</div><div class="hits">1</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"> <td class="line">1</td><td class="hits">1</td><td class="source">require('../util').expose(module);</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/parser.js">lib/plugin/parser.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">32</div><div class="hits">32</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Simple parser for url query and post/put parameters.</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var parseQuerystring = require('querystring').parse;</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var parseUrl = require('url').parse;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * Module exports.</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @type {{name: string, attach: Function}}</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">19</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   * Name of the plugin.</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">  name: &quot;Parser&quot;,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   * Setup function, call once during the middleware setup process</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * @param core {Object} Instance of Core class</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   * @param [options] {Object} middleware specific settings</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">   * @return {Function} Function will be called for each new request</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  attach: function (core, options) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">6</td><td class="source">    options = options || {};</td></tr><tr class="hit"> <td class="line">38</td><td class="hits">6</td><td class="source">    options.encoding = options.encoding || 'utf8';</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">6</td><td class="source">    options.maxIncomingSize = options.maxIncomingSize || 256 * 1024;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">41</td><td class="hits">6</td><td class="source">    return function (request, response, go) {</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">6</td><td class="source">      var context = this;</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">6</td><td class="source">      var urlObj = parseUrl(request.url);</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">6</td><td class="source">      if (urlObj.query) {</td></tr><tr class="hit"> <td class="line">45</td><td class="hits">2</td><td class="source">        this.query = parseQuerystring(urlObj.query);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">48</td><td class="hits">6</td><td class="source">      if (request.method === 'POST' || request.method === 'PUT' || request.method === 'DELETE') {</td></tr><tr class="hit"> <td class="line">49</td><td class="hits">4</td><td class="source">        request.setEncoding(options.encoding);</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">4</td><td class="source">        var contentLength = parseInt(request.headers['content-length'], 10);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">52</td><td class="hits">4</td><td class="source">        if (isNaN(contentLength) || contentLength &gt; options.maxIncomingSize) {</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">          // not a vaild request</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">1</td><td class="source">          request.removeAllListeners();</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">1</td><td class="source">          response.writeHead(413, {'Connection': 'close'});</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">1</td><td class="source">          response.end();</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">1</td><td class="source">          return;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">60</td><td class="hits">3</td><td class="source">        var buff = '';</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">3</td><td class="source">        request.on(&quot;data&quot;, function (chunk) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">3</td><td class="source">          buff += chunk;</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">65</td><td class="hits">3</td><td class="source">        var contentType = request.headers['content-type'];</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">3</td><td class="source">        request.on(&quot;end&quot;, function () {</td></tr><tr class="hit"> <td class="line">67</td><td class="hits">3</td><td class="source">          context.data = buff;</td></tr><tr class="hit"> <td class="line">68</td><td class="hits">3</td><td class="source">          if (contentType === 'application/x-www-form-urlencoded') {</td></tr><tr class="hit"> <td class="line">69</td><td class="hits">1</td><td class="source">            context.param = parseQuerystring(buff);</td></tr><tr class="hit"> <td class="line">70</td><td class="hits">2</td><td class="source">          } else if (/json|javascript/.test(contentType)) {</td></tr><tr class="hit"> <td class="line">71</td><td class="hits">2</td><td class="source">            try {</td></tr><tr class="hit"> <td class="line">72</td><td class="hits">2</td><td class="source">              context.json = JSON.parse(buff);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            } catch (e) {</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">3</td><td class="source">          go();</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">2</td><td class="source">        go();</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/router.js">lib/plugin/router.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">17</div><div class="hits">17</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Router plugin for working with middleware</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Router = require('../router').Router;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @type {{name: string, attach: Function}}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">18</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * Name of the plugin</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  name: 'Router',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   * Plugin setup function</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   * @param core {Object} Instance of Core class</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * @param [options] {Object} Optional options for router plugin or instance of Router</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  attach: function (core, options) {</td></tr><tr class="hit"> <td class="line">35</td><td class="hits">13</td><td class="source">    var router;</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">13</td><td class="source">    if (options instanceof Router) {</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">1</td><td class="source">      router = options;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">12</td><td class="source">      options = options || {};</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">12</td><td class="source">      router = new Router(options);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">13</td><td class="source">    core.router = router;</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">44</td><td class="hits">13</td><td class="source">    return function (request, response, go) {</td></tr><tr class="hit"> <td class="line">45</td><td class="hits">13</td><td class="source">      var matched = router.route(request.method, request.url, this, function (request, response) {</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">1</td><td class="source">        var notFound = options.notFound || function (request, response) {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">1</td><td class="source">          var error = {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            statusCode: 404,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            message: 'Content not found: ' + request.url</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">          };</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">1</td><td class="source">          this.error(error);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">1</td><td class="source">        notFound.call(this, request, response);</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">1</td><td class="source">        go();</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">13</td><td class="source">      if (matched) {</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">12</td><td class="source">        go();</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/securecookie.js">lib/plugin/securecookie.js</h2><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">49</div><div class="hits">46</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Plugin for decrypting and verifying secure cookie</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var c = require('../crypto');</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var cipher = c.cipher;</td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var decipher = c.decipher;</td></tr><tr class="hit"> <td class="line">12</td><td class="hits">1</td><td class="source">var auth = require('../auth');</td></tr><tr class="hit"> <td class="line">13</td><td class="hits">1</td><td class="source">var cookieHelper = require('../cookie');</td></tr><tr class="hit"> <td class="line">14</td><td class="hits">1</td><td class="source">var parse = cookieHelper.parse;</td></tr><tr class="hit"> <td class="line">15</td><td class="hits">1</td><td class="source">var stringify = cookieHelper.stringify;</td></tr><tr class="hit"> <td class="line">16</td><td class="hits">1</td><td class="source">var extend = require('../util').extend;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @type {{name: string, attach: Function}}</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">24</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   * Name of the plugin</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  name: 'SecureCookie',</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">   * Plugin setup function</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">   * @param core {Object} Instance object of Core</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">   * @param options {Object} Plugin options:</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">   *   - secureKey {String} Key use to encrypt the signed cookie</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">   *   - serverKey {String} Hmac key use to sign the cookie</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">   *   - cookieName {String} Name of the cookie</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">   *   - [cookiePath] {String} Path of the cookie</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">   *   - [cookieDomain] {String} Domain of the cookie</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  attach: function (core, options) {</td></tr><tr class="hit"> <td class="line">45</td><td class="hits">2</td><td class="source">    var secureKey = options.secureKey;</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">2</td><td class="source">    var cookieName = options.cookieName;</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">2</td><td class="source">    var cookiePath = options.cookiePath;</td></tr><tr class="hit"> <td class="line">48</td><td class="hits">2</td><td class="source">    var cookieDomain = options.cookieDomain;</td></tr><tr class="hit"> <td class="line">49</td><td class="hits">2</td><td class="source">    var serverKey = options.serverKey;</td></tr><tr class="hit"> <td class="line">50</td><td class="hits">2</td><td class="source">    var cookieOption = {};</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">52</td><td class="hits">2</td><td class="source">    if (cookiePath) {</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">2</td><td class="source">      cookieOption.path = cookiePath;</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">56</td><td class="hits">2</td><td class="source">    if (cookieDomain) {</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">2</td><td class="source">      cookieOption.domain = cookieDomain;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    // encrypt cookie if found in response header</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">2</td><td class="source">    core.add('writeHead', function (statusCode, headers, next) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">2</td><td class="source">      if (headers.hasOwnProperty(cookieName)) {</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        // build the cookie string from specified property of `headers`</td></tr><tr class="hit"> <td class="line">64</td><td class="hits">1</td><td class="source">        var originalCookie = headers[cookieName];</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        // sign the cookie by hmac</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">1</td><td class="source">        var signed = auth.sign(originalCookie[0], originalCookie[1], originalCookie[2], serverKey);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        // encrypt signed cookie into base64 string</td></tr><tr class="hit"> <td class="line">68</td><td class="hits">1</td><td class="source">        var encryptedBase64 = cipher(signed, secureKey, {outputEncoding: 'base64'});</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        // set other cookie option</td></tr><tr class="hit"> <td class="line">70</td><td class="hits">1</td><td class="source">        var option = extend({}, cookieOption, originalCookie[3]);</td></tr><tr class="hit"> <td class="line">71</td><td class="hits">1</td><td class="source">        option.expires = originalCookie[1];</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        // make the cookie</td></tr><tr class="hit"> <td class="line">74</td><td class="hits">1</td><td class="source">        var cookieStr = stringify(cookieName, encryptedBase64, option);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        // delete the original raw cookie</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">1</td><td class="source">        delete headers[cookieName];</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        // try to put the cookie string into `headers`</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">1</td><td class="source">        var setCookie = this.getHeader('Set-Cookie');</td></tr><tr class="hit"> <td class="line">80</td><td class="hits">1</td><td class="source">        if (!Array.isArray(setCookie)) {</td></tr><tr class="miss"> <td class="line">81</td><td class="hits">0</td><td class="source">          setCookie = [];</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">83</td><td class="hits">1</td><td class="source">        setCookie.push(cookieStr);</td></tr><tr class="hit"> <td class="line">84</td><td class="hits">1</td><td class="source">        this.setHeader('Set-Cookie', setCookie);</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">86</td><td class="hits">1</td><td class="source">        next(statusCode, headers);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        // do nothing and go to next step</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">1</td><td class="source">        return true;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">93</td><td class="hits">2</td><td class="source">    return function (req, res, go) {</td></tr><tr class="hit"> <td class="line">94</td><td class="hits">2</td><td class="source">      var cookies = parse(req.headers.cookie);</td></tr><tr class="hit"> <td class="line">95</td><td class="hits">2</td><td class="source">      var cookie = cookies[cookieName];</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">97</td><td class="hits">2</td><td class="source">      if (cookie) {</td></tr><tr class="hit"> <td class="line">98</td><td class="hits">1</td><td class="source">        var decrypted = auth.verify(decipher(cookie, secureKey, {inputEncoding: 'base64'}), serverKey);</td></tr><tr class="hit"> <td class="line">99</td><td class="hits">1</td><td class="source">        if (!decrypted) {</td></tr><tr class="miss"> <td class="line">100</td><td class="hits">0</td><td class="source">          return go();</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">102</td><td class="hits">1</td><td class="source">        var data = decrypted[2];</td></tr><tr class="hit"> <td class="line">103</td><td class="hits">1</td><td class="source">        try {</td></tr><tr class="hit"> <td class="line">104</td><td class="hits">1</td><td class="source">          data = JSON.parse(decrypted[2]);</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        } catch (e) {</td></tr><tr class="miss"> <td class="line">106</td><td class="hits">0</td><td class="source">          console.error('JSON parsing error for object: %s', data);</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">108</td><td class="hits">1</td><td class="source">        this.session = extend({}, this.session, {</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">          cookieId: decrypted[0],</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">          cookieExpires: new Date(decrypted[1]),</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">          cookieData: data</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        // for later usage</td></tr><tr class="hit"> <td class="line">114</td><td class="hits">1</td><td class="source">        this.cookies = cookies;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">116</td><td class="hits">2</td><td class="source">      go();</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/plugin/view.js">lib/plugin/view.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">17</div><div class="hits">16</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * View module plugin extends context with template rendering functions</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var View = require('../view').View;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @type {{name: String, module: Object}}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">18</td><td class="hits">1</td><td class="source">module.exports = {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">   * Name of the plugin</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">  name: &quot;View&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  attach: function (core, options) {</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">2</td><td class="source">    if (options instanceof View) {</td></tr><tr class="miss"> <td class="line">28</td><td class="hits">0</td><td class="source">      core.view = options;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">30</td><td class="hits">2</td><td class="source">      core.view = new View(options.engine, options);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">   * View module object</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  module: {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">     * Render a template/layout with given view context data</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">     * @param [path] {String} Path or name of the template file</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">     * @param [ctx] {Object} Data for rendering template</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">     * @param [callback] {function} Callback function for handling result, default is to send out result as html text</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">     */</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    render: function (path, ctx, callback) {</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">4</td><td class="source">      if ('string' !== typeof path) {</td></tr><tr class="hit"> <td class="line">52</td><td class="hits">1</td><td class="source">        callback = ctx;</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">1</td><td class="source">        ctx = path;</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">1</td><td class="source">        path = this.viewPath;</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">56</td><td class="hits">4</td><td class="source">      var self = this;</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">4</td><td class="source">      if ('function' !== typeof callback) {</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">3</td><td class="source">        callback = function (err, html) {</td></tr><tr class="hit"> <td class="line">59</td><td class="hits">3</td><td class="source">          if (err) {</td></tr><tr class="hit"> <td class="line">60</td><td class="hits">1</td><td class="source">            self.error({error: err, statusCode: 503, message: 'Failed to render file', context: self});</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">1</td><td class="source">            return;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"> <td class="line">63</td><td class="hits">2</td><td class="source">          self.sendHTML(html);</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">4</td><td class="source">      this.view.renderFile(path, ctx || {}, callback);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="lib/router.js">lib/router.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">194</div><div class="hits">175</div><div class="misses">19</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">5</td><td class="hits">1</td><td class="source">var chain = require('./control').chain;</td></tr><tr class="hit"> <td class="line">6</td><td class="hits">1</td><td class="source">var util = require('./util');</td></tr><tr class="hit"> <td class="line">7</td><td class="hits">1</td><td class="source">var extend = util.extend;</td></tr><tr class="hit"> <td class="line">8</td><td class="hits">1</td><td class="source">var toArray = util.toArray;</td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Context = require('./core').Context;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">15</td><td class="hits">1</td><td class="source">exports.Router = Router;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Constructor function of Router class</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * @param [routes] {Array} Optional predefined routing definitions</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @param [options] {Object} Optional router options which may contains:</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> *   - &quot;contextClass&quot; The constructor function of the context class</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *   - &quot;urlRoot&quot; The default url prefix</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> * @private</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">function Router(routes, options) {</td></tr><tr class="hit"> <td class="line">29</td><td class="hits">30</td><td class="source">  this.rules = [];</td></tr><tr class="hit"> <td class="line">30</td><td class="hits">30</td><td class="source">  if (!Array.isArray(routes)) {</td></tr><tr class="hit"> <td class="line">31</td><td class="hits">22</td><td class="source">    options = routes;</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">22</td><td class="source">    routes = null;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">34</td><td class="hits">30</td><td class="source">  options = options || {};</td></tr><tr class="hit"> <td class="line">35</td><td class="hits">30</td><td class="source">  this.urlRoot = options.urlRoot || '^/';</td></tr><tr class="hit"> <td class="line">36</td><td class="hits">30</td><td class="source">  if (this.urlRoot[0] !== '^') {</td></tr><tr class="miss"> <td class="line">37</td><td class="hits">0</td><td class="source">    this.urlRoot = '^' + this.urlRoot;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">30</td><td class="source">  if (this.urlRoot[this.urlRoot.length - 1] !== '/') {</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">4</td><td class="source">    this.urlRoot += '/';</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">30</td><td class="source">  this.contextClass = options.contextClass || Context;</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">30</td><td class="source">  if (Array.isArray(routes)) {</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">8</td><td class="source">    this.mount(routes);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> * Prototype object of Router class</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> * @type {Object}</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">54</td><td class="hits">1</td><td class="source">Router.prototype = {</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">   * Supported routing types</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  supportedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'HEAD', 'NOTFOUND'],</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">   * The routing method that routes and dispatches incoming request</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">   * @param type {String} Type of the routing request</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">   * @param url {String} Url of the request</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">   * @param context {Object} Dispatching context</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   * @param [notFound] {Function} Optional function to handle miss matched request</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">   * @return {Boolean} True if matched otherwise false</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">  route: function (type, url, context, notFound) {</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    function route(context, input, routes, notFound) {</td></tr><tr class="hit"> <td class="line">75</td><td class="hits">46</td><td class="source">      var _routes = routes[input.type];</td></tr><tr class="hit"> <td class="line">76</td><td class="hits">46</td><td class="source">      if (_routes) {</td></tr><tr class="hit"> <td class="line">77</td><td class="hits">45</td><td class="source">        for (var i in _routes) {</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">70</td><td class="source">          if (_routes.hasOwnProperty(i)) {</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">70</td><td class="source">            var _route = _routes[i];</td></tr><tr class="hit"> <td class="line">80</td><td class="hits">70</td><td class="source">            var condition = input.matched ? input.matched : input.condition;</td></tr><tr class="hit"> <td class="line">81</td><td class="hits">70</td><td class="source">            var matched = _route.match(condition);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            // matched or replaced</td></tr><tr class="hit"> <td class="line">83</td><td class="hits">70</td><td class="source">            if (matched !== null) {</td></tr><tr class="hit"> <td class="line">84</td><td class="hits">48</td><td class="source">              if (Array.isArray(matched)) {</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                // destination arrived, do dispatching</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                // and keep the context of `route`</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">31</td><td class="source">                _route.dispatch(matched, context);</td></tr><tr class="hit"> <td class="line">88</td><td class="hits">31</td><td class="source">                return true;</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">17</td><td class="source">              } else if (matched !== condition) {</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                // part of the `condition` is replaced, `matched` will become new condition</td></tr><tr class="hit"> <td class="line">91</td><td class="hits">10</td><td class="source">                input.matched = matched;</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                // route to sub-module</td></tr><tr class="hit"> <td class="line">93</td><td class="hits">10</td><td class="source">                if (route(context, input, _route.routes)) {</td></tr><tr class="hit"> <td class="line">94</td><td class="hits">10</td><td class="source">                  return true;</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">102</td><td class="hits">5</td><td class="source">      if ('NOTFOUND' !== input.type) {</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        // if nothing matched, route to `NOTFOUND` and do appropriate operations.</td></tr><tr class="hit"> <td class="line">104</td><td class="hits">3</td><td class="source">        if (route(context, {condition: input.condition, type: 'NOTFOUND', matched: input.matched}, routes)) {</td></tr><tr class="hit"> <td class="line">105</td><td class="hits">1</td><td class="source">          return true;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      // if rules of `NOTFOUND` is not matched, call the `notFound` function if supplied.</td></tr><tr class="hit"> <td class="line">109</td><td class="hits">4</td><td class="source">      return !!(notFound &amp;&amp; notFound.call(context, context.request, context.response));</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">112</td><td class="hits">33</td><td class="source">    var input = {type: type, condition: url};</td></tr><tr class="hit"> <td class="line">113</td><td class="hits">33</td><td class="source">    return route(context, input, this.getRoutes(), notFound);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">   * Add batch of routing rules in declarative format</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">   * @param routes {Array} Array of routes definition</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">  mount: function (routes) {</td></tr><tr class="hit"> <td class="line">124</td><td class="hits">17</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">125</td><td class="hits">17</td><td class="source">    routes.forEach(function (route) {</td></tr><tr class="hit"> <td class="line">126</td><td class="hits">27</td><td class="source">      var def = self.normalizeRouteDefinition(route);</td></tr><tr class="hit"> <td class="line">127</td><td class="hits">27</td><td class="source">      self.add(def.method, def.pattern, def.handler, def.hooks);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">   * Add a signle route definition to this router</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">   * @param method {String} Http method string</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">   * @param pattern {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">   * @param handler {Function} Function that will be called during dispatch</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">  add: function (method, pattern, handler, hooks) {</td></tr><tr class="hit"> <td class="line">145</td><td class="hits">41</td><td class="source">    var _method = method.toUpperCase();</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">147</td><td class="hits">41</td><td class="source">    if (this.supportedMethods.indexOf(_method) === -1) {</td></tr><tr class="miss"> <td class="line">148</td><td class="hits">0</td><td class="source">      throw new Error('Routing method `' + _method + '` not supported.');</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">151</td><td class="hits">41</td><td class="source">    var rule = {type: _method, pattern: pattern};</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    // sanity check for all possible formats of handler</td></tr><tr class="hit"> <td class="line">154</td><td class="hits">41</td><td class="source">    if (Array.isArray(handler) &amp;&amp; Array.isArray(handler[0])) {</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">      // handler is an array of sub-url routing definitions</td></tr><tr class="hit"> <td class="line">156</td><td class="hits">6</td><td class="source">      var routes = handler;</td></tr><tr class="hit"> <td class="line">157</td><td class="hits">6</td><td class="source">      routes.forEach(function (def) {</td></tr><tr class="hit"> <td class="line">158</td><td class="hits">10</td><td class="source">        if (!Array.isArray(def)) {</td></tr><tr class="miss"> <td class="line">159</td><td class="hits">0</td><td class="source">          throw new Error('Element of sub-url definition should be type of array.');</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">163</td><td class="hits">6</td><td class="source">      var self = this;</td></tr><tr class="hit"> <td class="line">164</td><td class="hits">6</td><td class="source">      routes.forEach(function (url, idx) {</td></tr><tr class="hit"> <td class="line">165</td><td class="hits">10</td><td class="source">        var def = self.normalizeRouteDefinition(url, {method: _method});</td></tr><tr class="hit"> <td class="line">166</td><td class="hits">10</td><td class="source">        if (hooks) {</td></tr><tr class="hit"> <td class="line">167</td><td class="hits">4</td><td class="source">          def.hooks = self.stackHook(hooks, def.hooks);</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">169</td><td class="hits">10</td><td class="source">        routes[idx] = [def.pattern, def.handler, def.method, def.hooks];</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">172</td><td class="hits">6</td><td class="source">      var subRouter = new Router(routes);</td></tr><tr class="hit"> <td class="line">173</td><td class="hits">6</td><td class="source">      rule.rules = subRouter.rules;</td></tr><tr class="hit"> <td class="line">174</td><td class="hits">35</td><td class="source">    } else if ('function' === typeof handler) {</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">      // the simplest case, `handler` is a function</td></tr><tr class="hit"> <td class="line">176</td><td class="hits">35</td><td class="source">      rule._handleFunction = handler;</td></tr><tr class="hit"> <td class="line">177</td><td class="hits">35</td><td class="source">      if (hooks) {</td></tr><tr class="hit"> <td class="line">178</td><td class="hits">7</td><td class="source">        rule.hooks = hooks;</td></tr><tr class="hit"> <td class="line">179</td><td class="hits">7</td><td class="source">        handler = this.stackHook(hooks, [handler]);</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">        // build the function chain</td></tr><tr class="hit"> <td class="line">181</td><td class="hits">7</td><td class="source">        handler = this.chainFn(handler);</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">183</td><td class="hits">35</td><td class="source">      rule.handler = handler;</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"> <td class="line">185</td><td class="hits">0</td><td class="source">      throw new Error('Format of url definition not correct' +</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">        ', second item of definition array should be a function or definition of sub-urls. Got: ' + typeof handler);</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    // reversed for `NOTFOUND` make it easy to override the default one</td></tr><tr class="hit"> <td class="line">189</td><td class="hits">41</td><td class="source">    if ('NOTFOUND' === _method) {</td></tr><tr class="hit"> <td class="line">190</td><td class="hits">1</td><td class="source">      this.rules.unshift(rule);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">192</td><td class="hits">40</td><td class="source">      this.rules.push(rule);</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">194</td><td class="hits">41</td><td class="source">    return this;</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">   * Define a route with type 'GET'</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">  get: function (url, handler, hooks) {</td></tr><tr class="hit"> <td class="line">210</td><td class="hits">8</td><td class="source">    this.mount([</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">      [url, handler, 'get', hooks]</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="hit"> <td class="line">213</td><td class="hits">8</td><td class="source">    return this;</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">   * Define a route with type 'POST'</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">  post: function (url, handler, hooks) {</td></tr><tr class="hit"> <td class="line">229</td><td class="hits">1</td><td class="source">    this.mount([</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">      [url, handler, 'post', hooks]</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="hit"> <td class="line">232</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">   * Define a route with type 'PUT'</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">  put: function (url, handler, hooks) {</td></tr><tr class="miss"> <td class="line">248</td><td class="hits">0</td><td class="source">    this.mount([</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">      [url, handler, 'put', hooks]</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="miss"> <td class="line">251</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">   * Define a route with type 'DELETE'</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">  'delete': function (url, handler, hooks) {</td></tr><tr class="miss"> <td class="line">267</td><td class="hits">0</td><td class="source">    this.mount([</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">      [url, handler, 'delete', hooks]</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="miss"> <td class="line">270</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">   * Define a route with type 'HEAD'</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">  head: function (url, handler, hooks) {</td></tr><tr class="miss"> <td class="line">286</td><td class="hits">0</td><td class="source">    this.mount([</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">      [url, handler, 'head', hooks]</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="miss"> <td class="line">289</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">   * Define a route with type 'NOTFOUND'</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">   * @param url {String|RegExp} A RegExp instance or string to repersent matching pattern</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">   * @param handler {Function} Function to handle the request</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">   * @param [hooks] {Array|Function} An optional hook object:</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">   *  - Array: an array of hook functions</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">   *  - Function: a single pre hook function</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">  notFound: function (url, handler, hooks) {</td></tr><tr class="miss"> <td class="line">305</td><td class="hits">0</td><td class="source">    this.mount([</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">      [url, handler, 'notFound', hooks]</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">    ]);</td></tr><tr class="miss"> <td class="line">308</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">   * Get the built routes of the router.</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">   * @return {Object} Routes object which can be used to do routing with `route` method</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">  getRoutes: function () {</td></tr><tr class="hit"> <td class="line">319</td><td class="hits">34</td><td class="source">    if (!this.routes) {</td></tr><tr class="hit"> <td class="line">320</td><td class="hits">20</td><td class="source">      this.build();</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">322</td><td class="hits">33</td><td class="source">    return this.routes;</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">   * Add global hooks to all existent routes</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">   * @param hooks {Function|Array} Hook functions</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">  hook: function (hooks) {</td></tr><tr class="hit"> <td class="line">333</td><td class="hits">1</td><td class="source">    hooks = this.normalizeHooks(hooks);</td></tr><tr class="hit"> <td class="line">334</td><td class="hits">1</td><td class="source">    if (Array.isArray(hooks) &amp;&amp; hooks.length &gt; 0) {</td></tr><tr class="hit"> <td class="line">335</td><td class="hits">1</td><td class="source">      var self = this;</td></tr><tr class="hit"> <td class="line">336</td><td class="hits">1</td><td class="source">      var _hook = function (rules) {</td></tr><tr class="hit"> <td class="line">337</td><td class="hits">7</td><td class="source">        rules.forEach(function (rule) {</td></tr><tr class="hit"> <td class="line">338</td><td class="hits">18</td><td class="source">          if (rule.rules) {</td></tr><tr class="hit"> <td class="line">339</td><td class="hits">6</td><td class="source">            _hook(rule.rules);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"> <td class="line">341</td><td class="hits">12</td><td class="source">            rule.hooks = self.stackHook(hooks, rule.hooks);</td></tr><tr class="hit"> <td class="line">342</td><td class="hits">12</td><td class="source">            rule.handler = self.stackHook(rule.hooks, [rule._handleFunction]);</td></tr><tr class="hit"> <td class="line">343</td><td class="hits">12</td><td class="source">            rule.handler = self.chainFn(rule.handler);</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">      };</td></tr><tr class="hit"> <td class="line">347</td><td class="hits">1</td><td class="source">      _hook(this.rules);</td></tr><tr class="hit"> <td class="line">348</td><td class="hits">1</td><td class="source">      this.routes = this.build();</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">   * Generate a url based on the camel cased name string</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">   * @param name {String} Camel cased name</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">   * @returns {string}</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">  slashCamelCase: function (name) {</td></tr><tr class="hit"> <td class="line">361</td><td class="hits">20</td><td class="source">    name = name.replace(/([A-Z]+)/g, function (word) {</td></tr><tr class="hit"> <td class="line">362</td><td class="hits">34</td><td class="source">      return '/' + word.toLowerCase();</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">364</td><td class="hits">20</td><td class="source">    return name;</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">   * Combine url with perfix</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">   * @param prefix {String} Prefix string</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">   * @param url {String} Url string</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">   * @returns {String}</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">  prefixUrl: function (prefix, url) {</td></tr><tr class="hit"> <td class="line">377</td><td class="hits">59</td><td class="source">    switch (url[0]) {</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">      case '^':</td></tr><tr class="hit"> <td class="line">379</td><td class="hits">52</td><td class="source">        return url;</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">      case '/':</td></tr><tr class="hit"> <td class="line">381</td><td class="hits">3</td><td class="source">        url = url.slice(1);</td></tr><tr class="hit"> <td class="line">382</td><td class="hits">3</td><td class="source">        break;</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">385</td><td class="hits">7</td><td class="source">    if (prefix[prefix.length - 1] !== '/') {</td></tr><tr class="miss"> <td class="line">386</td><td class="hits">0</td><td class="source">      prefix += '/';</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">388</td><td class="hits">7</td><td class="source">    url = prefix + url;</td></tr><tr class="hit"> <td class="line">389</td><td class="hits">7</td><td class="source">    return url;</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">   * Listen to the request event of HttpServer instance</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">   * @param server {Object} Instance object of &quot;http.HttpServer&quot;</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">   * @param contextClass {Function} The context constructor function</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">   * @param [notFound] {Function} Optional function to handle miss matched url</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">  listen: function (server, contextClass, notFound) {</td></tr><tr class="hit"> <td class="line">402</td><td class="hits">8</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">403</td><td class="hits">8</td><td class="source">    contextClass = contextClass || this.contextClass;</td></tr><tr class="hit"> <td class="line">404</td><td class="hits">8</td><td class="source">    if ('function' !== typeof notFound) {</td></tr><tr class="hit"> <td class="line">405</td><td class="hits">8</td><td class="source">      notFound = function (request, response) {</td></tr><tr class="miss"> <td class="line">406</td><td class="hits">0</td><td class="source">        response.statusCode = 404;</td></tr><tr class="miss"> <td class="line">407</td><td class="hits">0</td><td class="source">        response.end('404 not found!', 'utf8');</td></tr><tr class="miss"> <td class="line">408</td><td class="hits">0</td><td class="source">        console.error('Cannot match a route for url &quot;%s&quot; method &quot;%s&quot;', request.url, request.method);</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">      };</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">411</td><td class="hits">8</td><td class="source">    server.on('request', function (request, response) {</td></tr><tr class="hit"> <td class="line">412</td><td class="hits">8</td><td class="source">      var context = new contextClass(request, response);</td></tr><tr class="hit"> <td class="line">413</td><td class="hits">8</td><td class="source">      self.route(request.method, request.url, context, notFound);</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">   * Check the input url pattern and format it to regexp if need</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">   * @param {String|RegExp} pattern Url pattern in format of string or regular expression</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">   * @returns {RegExp}</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">   * @throws {Error}</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">  normalizePattern: function (pattern) {</td></tr><tr class="hit"> <td class="line">427</td><td class="hits">58</td><td class="source">    if (pattern instanceof RegExp) {</td></tr><tr class="miss"> <td class="line">428</td><td class="hits">0</td><td class="source">      return pattern;</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">430</td><td class="hits">58</td><td class="source">    if (typeof pattern === &quot;string&quot;) {</td></tr><tr class="hit"> <td class="line">431</td><td class="hits">57</td><td class="source">      pattern = this.prefixUrl(this.urlRoot, pattern);</td></tr><tr class="hit"> <td class="line">432</td><td class="hits">57</td><td class="source">      return new RegExp(pattern);</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">434</td><td class="hits">1</td><td class="source">    throw new Error(&quot;Invalid url pattern&quot;);</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">   * Normalize the route definition array to object</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">   * @param route {Array} Single route definition array</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">   * @param [defaults] {Object} Optional default value for missed value, only support `method` (e.g. {method: 'get'})</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">  normalizeRouteDefinition: function (route, defaults) {</td></tr><tr class="hit"> <td class="line">447</td><td class="hits">37</td><td class="source">    var method = route[2];</td></tr><tr class="hit"> <td class="line">448</td><td class="hits">37</td><td class="source">    var hooks = route[3];</td></tr><tr class="hit"> <td class="line">449</td><td class="hits">37</td><td class="source">    defaults = defaults || {};</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">451</td><td class="hits">37</td><td class="source">    if ('string' !== typeof method) {</td></tr><tr class="hit"> <td class="line">452</td><td class="hits">8</td><td class="source">      hooks = method;</td></tr><tr class="hit"> <td class="line">453</td><td class="hits">8</td><td class="source">      method = defaults.method || 'get';</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">456</td><td class="hits">37</td><td class="source">    hooks = this.normalizeHooks(hooks);</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">458</td><td class="hits">37</td><td class="source">    return {pattern: route[0], handler: route[1], method: method, hooks: hooks};</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">   * Convert function to array and add `null` to end of array if necessary</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source">   * @param hooks</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">   * @returns {Array}</td></tr><tr><td class="line">466</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">  normalizeHooks: function (hooks) {</td></tr><tr class="hit"> <td class="line">470</td><td class="hits">73</td><td class="source">    if (hooks) {</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">      // do sanity check for pre hooks</td></tr><tr class="hit"> <td class="line">472</td><td class="hits">44</td><td class="source">      if ('function' === typeof hooks) {</td></tr><tr class="hit"> <td class="line">473</td><td class="hits">1</td><td class="source">        hooks = [hooks];</td></tr><tr class="hit"> <td class="line">474</td><td class="hits">43</td><td class="source">      } else if (!Array.isArray(hooks)) {</td></tr><tr class="miss"> <td class="line">475</td><td class="hits">0</td><td class="source">        throw new Error('Hooks must be a function or array of functions');</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">477</td><td class="hits">44</td><td class="source">      hooks.forEach(function (hook) {</td></tr><tr class="hit"> <td class="line">478</td><td class="hits">142</td><td class="source">        if ('function' !== typeof hook &amp;&amp; null !== hook) {</td></tr><tr class="miss"> <td class="line">479</td><td class="hits">0</td><td class="source">          throw new Error('Hooks must be array of functions with optional null placeholder for function being hooked.');</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">483</td><td class="hits">44</td><td class="source">      if (hooks.indexOf(null) === -1) {</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">        // all pre hooks</td></tr><tr class="hit"> <td class="line">485</td><td class="hits">3</td><td class="source">        hooks.push(null);</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">488</td><td class="hits">73</td><td class="source">    return hooks;</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source">   * Wrap targetHooks with srcHooks</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">   * @param srcHooks {Array} Array of src hooks</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source">   * @param [targetHooks] Optional target hooks</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">   * @returns {Array}</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">  stackHook: function (srcHooks, targetHooks) {</td></tr><tr class="hit"> <td class="line">501</td><td class="hits">35</td><td class="source">    targetHooks = targetHooks || [null];</td></tr><tr class="hit"> <td class="line">502</td><td class="hits">35</td><td class="source">    srcHooks = this.normalizeHooks(srcHooks);</td></tr><tr class="hit"> <td class="line">503</td><td class="hits">35</td><td class="source">    var idx = srcHooks.indexOf(null);</td></tr><tr class="hit"> <td class="line">504</td><td class="hits">35</td><td class="source">    var pre = srcHooks.slice(0, idx++);</td></tr><tr class="hit"> <td class="line">505</td><td class="hits">35</td><td class="source">    targetHooks = pre.concat(targetHooks);</td></tr><tr class="hit"> <td class="line">506</td><td class="hits">35</td><td class="source">    if (idx !== srcHooks.length) {</td></tr><tr class="hit"> <td class="line">507</td><td class="hits">34</td><td class="source">      var post = srcHooks.slice(idx);</td></tr><tr class="hit"> <td class="line">508</td><td class="hits">34</td><td class="source">      targetHooks = targetHooks.concat(post);</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">510</td><td class="hits">35</td><td class="source">    return targetHooks;</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">   * Convert array of functions to a function chain which can be called in serial order</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">   * @param fns {Array} Array of functions</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">   * @returns {Function}</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">  chainFn: function (fns) {</td></tr><tr class="hit"> <td class="line">522</td><td class="hits">19</td><td class="source">    var fn = chain(fns, function (h, idx, arr, next, args) {</td></tr><tr class="hit"> <td class="line">523</td><td class="hits">42</td><td class="source">      args = toArray(args);</td></tr><tr class="hit"> <td class="line">524</td><td class="hits">42</td><td class="source">      args.push(next);</td></tr><tr class="hit"> <td class="line">525</td><td class="hits">42</td><td class="source">      if (h.apply(this, args)) {</td></tr><tr class="hit"> <td class="line">526</td><td class="hits">22</td><td class="source">        next();</td></tr><tr><td class="line">527</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">529</td><td class="hits">19</td><td class="source">    return function () {</td></tr><tr class="hit"> <td class="line">530</td><td class="hits">12</td><td class="source">      fn(0, arguments, this);</td></tr><tr><td class="line">531</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source">   * Build and return routes definition object which can be used by `route` method</td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">   * @param [rules] {Array}</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">  build: function (rules) {</td></tr><tr class="hit"> <td class="line">543</td><td class="hits">33</td><td class="source">    var routes = {};</td></tr><tr class="hit"> <td class="line">544</td><td class="hits">33</td><td class="source">    var _rules = rules;</td></tr><tr class="hit"> <td class="line">545</td><td class="hits">33</td><td class="source">    rules = rules || this.rules;</td></tr><tr class="hit"> <td class="line">546</td><td class="hits">33</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">547</td><td class="hits">33</td><td class="source">    rules.forEach(function (rule) {</td></tr><tr class="hit"> <td class="line">548</td><td class="hits">58</td><td class="source">      var hasSub = Array.isArray(rule.rules) &amp;&amp; rule.rules.length &gt; 0;</td></tr><tr class="hit"> <td class="line">549</td><td class="hits">58</td><td class="source">      var type = rule.type.toUpperCase();</td></tr><tr class="hit"> <td class="line">550</td><td class="hits">58</td><td class="source">      var handler = rule.handler;</td></tr><tr class="hit"> <td class="line">551</td><td class="hits">58</td><td class="source">      var pattern = self.normalizePattern(rule.pattern);</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">553</td><td class="hits">57</td><td class="source">      var current = {id: type + '_' + pattern.toString()};</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">555</td><td class="hits">57</td><td class="source">      if (hasSub) {</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">        // sub-urls</td></tr><tr class="hit"> <td class="line">557</td><td class="hits">12</td><td class="source">        current.match = function (condition) {</td></tr><tr class="hit"> <td class="line">558</td><td class="hits">17</td><td class="source">          return condition.replace(pattern, '');</td></tr><tr><td class="line">559</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"> <td class="line">560</td><td class="hits">12</td><td class="source">        current.routes = self.build(rule.rules);</td></tr><tr class="hit"> <td class="line">561</td><td class="hits">12</td><td class="source">        type = 'PREFIX';</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">563</td><td class="hits">45</td><td class="source">        current.dispatch = function (matched, context) {</td></tr><tr class="hit"> <td class="line">564</td><td class="hits">31</td><td class="source">          matched[0] = context;</td></tr><tr class="hit"> <td class="line">565</td><td class="hits">31</td><td class="source">          handler.apply(null, matched);</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"> <td class="line">567</td><td class="hits">45</td><td class="source">        current.match = function (condition) {</td></tr><tr class="hit"> <td class="line">568</td><td class="hits">53</td><td class="source">          return pattern.exec(condition);</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">570</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">572</td><td class="hits">57</td><td class="source">      if (!routes.hasOwnProperty(type)) {</td></tr><tr class="hit"> <td class="line">573</td><td class="hits">41</td><td class="source">        routes[type] = {};</td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">575</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">576</td><td class="hits">57</td><td class="source">      routes[type][current.id] = current;</td></tr><tr><td class="line">577</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">579</td><td class="hits">32</td><td class="source">    if (routes.PREFIX) {</td></tr><tr class="hit"> <td class="line">580</td><td class="hits">8</td><td class="source">      this.supportedMethods.forEach(function (type) {</td></tr><tr class="hit"> <td class="line">581</td><td class="hits">48</td><td class="source">        if (type !== 'NOTFOUND') {</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">          // method of sub-url may various, so put `prefix` to all types</td></tr><tr class="hit"> <td class="line">583</td><td class="hits">40</td><td class="source">          routes[type] = routes[type] || {};</td></tr><tr class="hit"> <td class="line">584</td><td class="hits">40</td><td class="source">          extend(routes[type], routes.PREFIX);</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">586</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">587</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">589</td><td class="hits">32</td><td class="source">    if (!_rules) {</td></tr><tr class="hit"> <td class="line">590</td><td class="hits">20</td><td class="source">      this.routes = routes;</td></tr><tr><td class="line">591</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">592</td><td class="hits">32</td><td class="source">    return routes;</td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">595</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/site.js">lib/site.js</h2><div id="stats" class="high"><div class="percentage">92%</div><div class="sloc">101</div><div class="hits">93</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">5</td><td class="hits">1</td><td class="source">var http = require('http');</td></tr><tr class="hit"> <td class="line">6</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter;</td></tr><tr class="hit"> <td class="line">7</td><td class="hits">1</td><td class="source">var Klass = require('./klass').Klass;</td></tr><tr class="hit"> <td class="line">8</td><td class="hits">1</td><td class="source">var extend = require('./util').extend;</td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Core = require('./core').Core;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Site constructor function</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @private</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">function Site() {</td></tr><tr class="hit"> <td class="line">19</td><td class="hits">4</td><td class="source">  EventEmitter.call(this);</td></tr><tr class="hit"> <td class="line">20</td><td class="hits">4</td><td class="source">  if (!process.env.NODE_ENV) {</td></tr><tr class="hit"> <td class="line">21</td><td class="hits">1</td><td class="source">    process.env.NODE_ENV = 'default';</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">23</td><td class="hits">4</td><td class="source">  this.data = {};</td></tr><tr class="hit"> <td class="line">24</td><td class="hits">4</td><td class="source">  this.plugins = {};</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">4</td><td class="source">  this.apps = {};</td></tr><tr class="hit"> <td class="line">26</td><td class="hits">4</td><td class="source">  this.core = new Core(this);</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">4</td><td class="source">  this.env();</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">4</td><td class="source">  this.set({</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    host: '127.0.0.1',</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    port: 8888</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * Site prototype object</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @type {Object}</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">40</td><td class="hits">1</td><td class="source">Site.prototype = {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">   * Switch between different environments</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">   * @param [name] {String} Optional env name, default is 'default'</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">   * @returns {Site}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  env: function (name) {</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">7</td><td class="source">    name = name || 'default';</td></tr><tr class="hit"> <td class="line">52</td><td class="hits">7</td><td class="source">    if (!this.data[name]) {</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">6</td><td class="source">      this.data[name] = {};</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">6</td><td class="source">      this.plugins[name] = {};</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">6</td><td class="source">      this.apps[name] = {};</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">57</td><td class="hits">7</td><td class="source">    this._env = name;</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">7</td><td class="source">    return this;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">   * Store a value for a key in current env</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   * @param key {String|Object} Key of the value or object of key/value pairs that need to be stored</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">   * @param value {*} Value that need to be stored</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">   * @returns {Object} The &quot;this&quot; object</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  set: function (key, value) {</td></tr><tr class="hit"> <td class="line">71</td><td class="hits">10</td><td class="source">    return _set(this, this.data, key, value);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">   * Get value for key</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">   * @param key {String|Array} Key of the value or array of keys</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">   * @returns {*} Value stored</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  get: function (key) {</td></tr><tr class="hit"> <td class="line">83</td><td class="hits">6</td><td class="source">    return _get(this, this.data, key);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">   * Use a plugin in current env</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">   * @param plugin {String|Object} The name string of the built-in plugin or the plugin object</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">   * @param [options] {Object} Optional plugin options</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">   * @returns {Object} The &quot;this&quot; object</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">  use: function (plugin, options) {</td></tr><tr class="hit"> <td class="line">96</td><td class="hits">7</td><td class="source">    var name = 'string' === typeof plugin ? plugin : plugin.name;</td></tr><tr class="hit"> <td class="line">97</td><td class="hits">7</td><td class="source">    var _plugin = {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">      plugin: plugin,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      options: options</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">102</td><td class="hits">7</td><td class="source">    return _set(this, this.plugins, name, _plugin);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">   * Load an app for current env</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">   * @param app {Function|Object|Array} App constructor or instance or array of apps</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">   * @param [options] {Object} Optional options for app constructor or routes if app is an instance object</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">   * @param [routes] {Object} Optional routes object</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">  load: function (app, options, routes) {</td></tr><tr class="hit"> <td class="line">116</td><td class="hits">1</td><td class="source">    if (Array.isArray(app)) {</td></tr><tr class="miss"> <td class="line">117</td><td class="hits">0</td><td class="source">      var self = this;</td></tr><tr class="miss"> <td class="line">118</td><td class="hits">0</td><td class="source">      app.forEach(function (_app) {</td></tr><tr class="miss"> <td class="line">119</td><td class="hits">0</td><td class="source">        self.load(_app, options, routes);</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">123</td><td class="hits">1</td><td class="source">    var name;</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">125</td><td class="hits">1</td><td class="source">    if ('function' === typeof app) {</td></tr><tr class="hit"> <td class="line">126</td><td class="hits">1</td><td class="source">      name = app.prototype.name;</td></tr><tr class="hit"> <td class="line">127</td><td class="hits">1</td><td class="source">      if (!routes) {</td></tr><tr class="hit"> <td class="line">128</td><td class="hits">1</td><td class="source">        routes = options;</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"> <td class="line">131</td><td class="hits">0</td><td class="source">      name = app.name;</td></tr><tr class="miss"> <td class="line">132</td><td class="hits">0</td><td class="source">      routes = options;</td></tr><tr class="miss"> <td class="line">133</td><td class="hits">0</td><td class="source">      options = null;</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">136</td><td class="hits">1</td><td class="source">    var _app = {</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">      app: app,</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">      options: options</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">141</td><td class="hits">1</td><td class="source">    this.map(routes);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">143</td><td class="hits">1</td><td class="source">    return _set(this, this.apps, name, _app);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">  map: function (routes) {</td></tr><tr class="hit"> <td class="line">147</td><td class="hits">2</td><td class="source">    if (routes) {</td></tr><tr class="hit"> <td class="line">148</td><td class="hits">1</td><td class="source">      var _routes = this.get('routes') || {};</td></tr><tr class="hit"> <td class="line">149</td><td class="hits">1</td><td class="source">      _routes = extend(_routes, routes);</td></tr><tr class="hit"> <td class="line">150</td><td class="hits">1</td><td class="source">      this.set('routes', _routes);</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">152</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">   * Process all the plugins with core</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">  usePlugins: function () {</td></tr><tr class="hit"> <td class="line">162</td><td class="hits">4</td><td class="source">    var plugins = extend({}, this.plugins['default']);</td></tr><tr class="hit"> <td class="line">163</td><td class="hits">4</td><td class="source">    if (process.env.NODE_ENV &amp;&amp; 'default' !== process.env.NODE_ENV) {</td></tr><tr class="hit"> <td class="line">164</td><td class="hits">2</td><td class="source">      extend(plugins, this.plugins[process.env.NODE_ENV]);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">167</td><td class="hits">4</td><td class="source">    var core = this.core;</td></tr><tr class="hit"> <td class="line">168</td><td class="hits">4</td><td class="source">    Object.keys(plugins).forEach(function (name) {</td></tr><tr class="hit"> <td class="line">169</td><td class="hits">7</td><td class="source">      var plugin = plugins[name];</td></tr><tr class="hit"> <td class="line">170</td><td class="hits">7</td><td class="source">      core.use(plugin.plugin, plugin.options);</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">172</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">   * Process all apps in current environment.</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">  loadApps: function () {</td></tr><tr class="hit"> <td class="line">182</td><td class="hits">4</td><td class="source">    var apps = extend({}, this.apps['default']);</td></tr><tr class="hit"> <td class="line">183</td><td class="hits">4</td><td class="source">    if (process.env.NODE_ENV &amp;&amp; 'default' !== process.env.NODE_ENV) {</td></tr><tr class="hit"> <td class="line">184</td><td class="hits">2</td><td class="source">      apps = extend(apps, this.apps[process.env.NODE_ENV]);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">187</td><td class="hits">4</td><td class="source">    var defaultAppOptions = this.get('appOptions');</td></tr><tr class="hit"> <td class="line">188</td><td class="hits">4</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">189</td><td class="hits">4</td><td class="source">    var core = self.core;</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">191</td><td class="hits">4</td><td class="source">    Object.keys(apps).forEach(function (k) {</td></tr><tr class="hit"> <td class="line">192</td><td class="hits">1</td><td class="source">      var appObj = apps[k];</td></tr><tr class="hit"> <td class="line">193</td><td class="hits">1</td><td class="source">      var appOptions = extend({}, defaultAppOptions, appObj.options);</td></tr><tr class="hit"> <td class="line">194</td><td class="hits">1</td><td class="source">      var app = appObj.app;</td></tr><tr class="hit"> <td class="line">195</td><td class="hits">1</td><td class="source">      if ('function' === typeof app) {</td></tr><tr class="hit"> <td class="line">196</td><td class="hits">1</td><td class="source">        app = new app(appOptions);</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">198</td><td class="hits">1</td><td class="source">      app.delegate = self;</td></tr><tr class="hit"> <td class="line">199</td><td class="hits">1</td><td class="source">      core.load(app);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">201</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">  mapRoutes: function () {</td></tr><tr class="hit"> <td class="line">205</td><td class="hits">4</td><td class="source">    var routes = extend({}, this.data['default'].routes);</td></tr><tr class="hit"> <td class="line">206</td><td class="hits">4</td><td class="source">    if (process.env.NODE_ENV &amp;&amp; 'default' !== process.env.NODE_ENV) {</td></tr><tr class="hit"> <td class="line">207</td><td class="hits">2</td><td class="source">      var dataEnv = this.data[process.env.NODE_ENV];</td></tr><tr class="hit"> <td class="line">208</td><td class="hits">2</td><td class="source">      routes = dataEnv ? extend(routes, dataEnv.routes) : routes;</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">210</td><td class="hits">4</td><td class="source">    this.core.map(routes);</td></tr><tr class="hit"> <td class="line">211</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">   * Create and start the http server using settings of current env</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">   * @param [server] {Object} Optional HttpServer instance</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">   * @returns {Object} HttpServer instance</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">  start: function (server) {</td></tr><tr class="hit"> <td class="line">223</td><td class="hits">4</td><td class="source">    this.usePlugins();</td></tr><tr class="hit"> <td class="line">224</td><td class="hits">4</td><td class="source">    this.loadApps();</td></tr><tr class="hit"> <td class="line">225</td><td class="hits">4</td><td class="source">    this.mapRoutes();</td></tr><tr class="hit"> <td class="line">226</td><td class="hits">4</td><td class="source">    var listener = this.core.getListener();</td></tr><tr class="hit"> <td class="line">227</td><td class="hits">4</td><td class="source">    if (server) {</td></tr><tr class="hit"> <td class="line">228</td><td class="hits">4</td><td class="source">      server.on('request', listener);</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"> <td class="line">230</td><td class="hits">0</td><td class="source">      server = http.createServer(listener);</td></tr><tr class="miss"> <td class="line">231</td><td class="hits">0</td><td class="source">      server.listen(this.get('port'), this.get('host'));</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">233</td><td class="hits">4</td><td class="source">    this.server = server;</td></tr><tr class="hit"> <td class="line">234</td><td class="hits">4</td><td class="source">    return server;</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> * Exposes Site</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">242</td><td class="hits">1</td><td class="source">exports.Site = Klass(EventEmitter, Site);</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> * Private setter function</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source"> * @param self {Object} The `this` object</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> * @param data {Object} Data hash to store values</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source"> * @param key {String|Object} Key of the value or object of key/value pairs that need to be stored</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> * @param value {*} Value that need to be stored</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> * @returns {Object} Self object</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> * @private</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">function _set(self, data, key, value) {</td></tr><tr class="hit"> <td class="line">256</td><td class="hits">18</td><td class="source">  var _data = data[self._env];</td></tr><tr class="hit"> <td class="line">257</td><td class="hits">18</td><td class="source">  if ('object' === typeof key) {</td></tr><tr class="hit"> <td class="line">258</td><td class="hits">4</td><td class="source">    extend(_data, key);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"> <td class="line">260</td><td class="hits">14</td><td class="source">    _data[key] = value;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">262</td><td class="hits">18</td><td class="source">  return self;</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> * Private getter function</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> * @param self {Object} The `this` object</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source"> * @param data {Object} Data hash to store values</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> * @param key {String|Array} Key of the value or array of keys</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> * @returns {*} Value stored</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> * @private</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">function _get(self, data, key) {</td></tr><tr class="hit"> <td class="line">277</td><td class="hits">8</td><td class="source">  if (Array.isArray(key)) {</td></tr><tr class="hit"> <td class="line">278</td><td class="hits">1</td><td class="source">    var values = {};</td></tr><tr class="hit"> <td class="line">279</td><td class="hits">1</td><td class="source">    key.forEach(function (k) {</td></tr><tr class="hit"> <td class="line">280</td><td class="hits">2</td><td class="source">      values[k] = _get(self, data, k);</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"> <td class="line">282</td><td class="hits">1</td><td class="source">    return values;</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">284</td><td class="hits">7</td><td class="source">  var _data = data[process.env.NODE_ENV];</td></tr><tr class="hit"> <td class="line">285</td><td class="hits">7</td><td class="source">  if (!_data || !_data.hasOwnProperty(key)) {</td></tr><tr class="hit"> <td class="line">286</td><td class="hits">5</td><td class="source">    _data = data['default'];</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">288</td><td class="hits">7</td><td class="source">  return _data[key];</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/util.js">lib/util.js</h2><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">47</div><div class="hits">44</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">5</td><td class="hits">1</td><td class="source">var path = require('path');</td></tr><tr class="hit"> <td class="line">6</td><td class="hits">1</td><td class="source">var fs = require('fs');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module exports</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">12</td><td class="hits">1</td><td class="source">exports.extend = extend;</td></tr><tr class="hit"> <td class="line">13</td><td class="hits">1</td><td class="source">exports.toArray = toArray;</td></tr><tr class="hit"> <td class="line">14</td><td class="hits">1</td><td class="source">exports.byteLength = byteLength;</td></tr><tr class="hit"> <td class="line">15</td><td class="hits">1</td><td class="source">exports.expose = expose;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Convert an array-like object to array (arguments etc.)</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * @param obj</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">function toArray(obj) {</td></tr><tr class="hit"> <td class="line">25</td><td class="hits">332</td><td class="source">  var len = obj.length,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      arr = new Array(len);</td></tr><tr class="hit"> <td class="line">27</td><td class="hits">332</td><td class="source">  for (var i = 0; i &lt; len; ++i) {</td></tr><tr class="hit"> <td class="line">28</td><td class="hits">601</td><td class="source">    arr[i] = obj[i];</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">30</td><td class="hits">332</td><td class="source">  return arr;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * Extend an object with given properties</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * @param obj</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @param props</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> * @return {*}</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">function extend(obj, props) {</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">142</td><td class="source">  var propsObj = toArray(arguments);</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">142</td><td class="source">  propsObj.shift();</td></tr><tr class="hit"> <td class="line">44</td><td class="hits">142</td><td class="source">  propsObj.forEach(function(props) {</td></tr><tr class="hit"> <td class="line">45</td><td class="hits">166</td><td class="source">    if (props) {</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">126</td><td class="source">      Object.keys(props).forEach(function(key) {</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">188</td><td class="source">        obj[key] = props[key];</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"> <td class="line">51</td><td class="hits">142</td><td class="source">  return obj;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> * Calculate byte length of string</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> * @param str</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> * @return {Number}</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">function byteLength(str) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">1</td><td class="source">  if (!str) {</td></tr><tr class="miss"> <td class="line">63</td><td class="hits">0</td><td class="source">    return 0;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">65</td><td class="hits">1</td><td class="source">  var matched = str.match(/[^\x00-\xff]/g);</td></tr><tr class="hit"> <td class="line">66</td><td class="hits">1</td><td class="source">  return (str.length + (!matched ? 0 : matched.length));</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> * Export sub modules under the module's directory</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> * @param module {Object} The global &quot;module&quot; inside each node.js source file context</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> * @param subModules {String|Array} Name(s) of the sub-module you want to expose</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">function expose(module, subModules) {</td></tr><tr class="hit"> <td class="line">78</td><td class="hits">6</td><td class="source">  var modulePath = path.dirname(module.filename);</td></tr><tr class="hit"> <td class="line">79</td><td class="hits">6</td><td class="source">  var exports_ = module.exports;</td></tr><tr class="hit"> <td class="line">80</td><td class="hits">6</td><td class="source">  if (subModules) {</td></tr><tr class="hit"> <td class="line">81</td><td class="hits">5</td><td class="source">    if (!Array.isArray(subModules)) {</td></tr><tr class="hit"> <td class="line">82</td><td class="hits">5</td><td class="source">      subModules = [subModules];</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">84</td><td class="hits">5</td><td class="source">    subModules.forEach(function (sub) {</td></tr><tr class="hit"> <td class="line">85</td><td class="hits">5</td><td class="source">      var subName;</td></tr><tr class="hit"> <td class="line">86</td><td class="hits">5</td><td class="source">      var subPath;</td></tr><tr class="hit"> <td class="line">87</td><td class="hits">5</td><td class="source">      if (sub[0] === '/') {</td></tr><tr class="hit"> <td class="line">88</td><td class="hits">5</td><td class="source">        subPath = sub;</td></tr><tr class="hit"> <td class="line">89</td><td class="hits">5</td><td class="source">        sub = sub.split('/');</td></tr><tr class="hit"> <td class="line">90</td><td class="hits">5</td><td class="source">        sub = sub[sub.length - 1];</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"> <td class="line">92</td><td class="hits">0</td><td class="source">        subName = sub;</td></tr><tr class="miss"> <td class="line">93</td><td class="hits">0</td><td class="source">        subPath = path.join(modulePath, subName);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">95</td><td class="hits">5</td><td class="source">      subName = sub.split('.')[0];</td></tr><tr class="hit"> <td class="line">96</td><td class="hits">5</td><td class="source">      var _module = {};</td></tr><tr class="hit"> <td class="line">97</td><td class="hits">5</td><td class="source">      _module[subName] = require(subPath);</td></tr><tr class="hit"> <td class="line">98</td><td class="hits">5</td><td class="source">      extend(exports_, _module);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"> <td class="line">101</td><td class="hits">1</td><td class="source">    subModules = fs.readdirSync(modulePath);</td></tr><tr class="hit"> <td class="line">102</td><td class="hits">1</td><td class="source">    if (subModules.length &gt; 0) {</td></tr><tr class="hit"> <td class="line">103</td><td class="hits">1</td><td class="source">      subModules.forEach(function (sub) {</td></tr><tr class="hit"> <td class="line">104</td><td class="hits">6</td><td class="source">        var subPath = path.join(modulePath, sub);</td></tr><tr class="hit"> <td class="line">105</td><td class="hits">6</td><td class="source">        var stats = fs.statSync(subPath);</td></tr><tr class="hit"> <td class="line">106</td><td class="hits">6</td><td class="source">        if ((stats.isDirectory() &amp;&amp; fs.existsSync(path.join(subPath, 'index.js'))) || (stats.isFile() &amp;&amp; path.extname(subPath) === '.js')) {</td></tr><tr class="hit"> <td class="line">107</td><td class="hits">6</td><td class="source">          if (subPath !== module.filename) {</td></tr><tr class="hit"> <td class="line">108</td><td class="hits">5</td><td class="source">            expose(module, subPath);</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="lib/view.js">lib/view.js</h2><div id="stats" class="high"><div class="percentage">98%</div><div class="sloc">159</div><div class="hits">157</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * View template manager</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * Module dependencies</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">9</td><td class="hits">1</td><td class="source">var Path = require('path');</td></tr><tr class="hit"> <td class="line">10</td><td class="hits">1</td><td class="source">var fs = require('fs');</td></tr><tr class="hit"> <td class="line">11</td><td class="hits">1</td><td class="source">var Base = require('./klass').Base;</td></tr><tr class="hit"> <td class="line">12</td><td class="hits">1</td><td class="source">var extend = require('./util').extend;</td></tr><tr class="hit"> <td class="line">13</td><td class="hits">1</td><td class="source">var parallel = require('./control').parallel;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * View constructor function.</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * @param engine {Object} Template engine instance object (e.g. hogan.js)</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * @param [options] {Object} View options:</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *  {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *    rootViewPath: '/path/to/your/view/templates', // The default absolute directory path of your template files</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> *    cache: true, // cache or not</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *    context: {x: 1}, // the default context of the view instance,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *    exts: ['.mu', '.js'] // template file extentions,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *    layout: {'name': ['partial.mu']} // initial layout</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *  }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * @constructor</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * @public</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">function View(engine, options) {</td></tr><tr class="hit"> <td class="line">32</td><td class="hits">10</td><td class="source">  if ('function' !== typeof engine.render &amp;&amp; 'function' !== typeof engine.compile) {</td></tr><tr class="miss"> <td class="line">33</td><td class="hits">0</td><td class="source">    throw new Error('Your template engine must implements at least one of &quot;render&quot; or &quot;compile&quot; functions.');</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">36</td><td class="hits">10</td><td class="source">  this.engine = engine;</td></tr><tr class="hit"> <td class="line">37</td><td class="hits">10</td><td class="source">  options = options || {};</td></tr><tr class="hit"> <td class="line">38</td><td class="hits">10</td><td class="source">  this.exts = options.exts || ['.mu', '.js'];</td></tr><tr class="hit"> <td class="line">39</td><td class="hits">10</td><td class="source">  this.contexts = {};</td></tr><tr class="hit"> <td class="line">40</td><td class="hits">10</td><td class="source">  this.viewPaths = {};</td></tr><tr class="hit"> <td class="line">41</td><td class="hits">10</td><td class="source">  this.rootViewPaths = {};</td></tr><tr class="hit"> <td class="line">42</td><td class="hits">10</td><td class="source">  this.partials = {};</td></tr><tr class="hit"> <td class="line">43</td><td class="hits">10</td><td class="source">  this.partialsEncoded = {};</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">45</td><td class="hits">10</td><td class="source">  if (options.rootViewPath) {</td></tr><tr class="hit"> <td class="line">46</td><td class="hits">7</td><td class="source">    this.rootViewPath = options.rootViewPath;</td></tr><tr class="hit"> <td class="line">47</td><td class="hits">7</td><td class="source">    this.registerPartialDir();</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">50</td><td class="hits">10</td><td class="source">  this.hasCompiler = 'function' === typeof this.engine.compile;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">52</td><td class="hits">10</td><td class="source">  if (options.cache) {</td></tr><tr class="hit"> <td class="line">53</td><td class="hits">2</td><td class="source">    this.cache = {};</td></tr><tr class="hit"> <td class="line">54</td><td class="hits">2</td><td class="source">    if (this.hasCompiler) {</td></tr><tr class="hit"> <td class="line">55</td><td class="hits">2</td><td class="source">      this.cacheCompiled = {};</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">58</td><td class="hits">10</td><td class="source">  if (options.context) {</td></tr><tr class="hit"> <td class="line">59</td><td class="hits">2</td><td class="source">    this.context = options.context;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">61</td><td class="hits">10</td><td class="source">  if (options.layout) {</td></tr><tr class="hit"> <td class="line">62</td><td class="hits">1</td><td class="source">    this.setLayout(options.layout);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"> <td class="line">64</td><td class="hits">10</td><td class="source">  if (options.minify) {</td></tr><tr class="hit"> <td class="line">65</td><td class="hits">1</td><td class="source">    this.minify = options.minify;</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> * View prototype object</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">73</td><td class="hits">1</td><td class="source">View.prototype = {</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">   * Set default rendering context for template file or layout</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">   * @param path {String} Path/name of the template/layout</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">   * @param context {Object} Context object</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">   * @returns {*}</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">  setContext: function (path, context) {</td></tr><tr class="hit"> <td class="line">85</td><td class="hits">1</td><td class="source">    this.contexts[path] = context;</td></tr><tr class="hit"> <td class="line">86</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">   * Render template with given context and partials</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">   * @param templateString {String} Template text string</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">   * @param [context] {Object} Template context object</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">   * @param [partials] {Object} Optional template partial object</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">   * @returns {String}</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">  render: function (templateString, context, partials) {</td></tr><tr class="hit"> <td class="line">100</td><td class="hits">13</td><td class="source">    if (this.hasCompiler) {</td></tr><tr class="hit"> <td class="line">101</td><td class="hits">10</td><td class="source">      var compiled;</td></tr><tr class="hit"> <td class="line">102</td><td class="hits">10</td><td class="source">      if (this.cacheCompiled) {</td></tr><tr class="hit"> <td class="line">103</td><td class="hits">4</td><td class="source">        compiled = this.cacheCompiled[templateString];</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">105</td><td class="hits">10</td><td class="source">      if (!compiled) {</td></tr><tr class="hit"> <td class="line">106</td><td class="hits">9</td><td class="source">        compiled = this.engine.compile(templateString);</td></tr><tr class="hit"> <td class="line">107</td><td class="hits">9</td><td class="source">        if (this.cacheCompiled) {</td></tr><tr class="hit"> <td class="line">108</td><td class="hits">3</td><td class="source">          this.cacheCompiled[templateString] = compiled;</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"> <td class="line">111</td><td class="hits">10</td><td class="source">      return compiled.render(extend({}, this.context, context), partials);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">113</td><td class="hits">3</td><td class="source">      return this.engine.render(templateString, extend({}, this.context, context), partials);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">   * Read the template from file and render it</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">   * @param path {String} Path to the template file</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">   * @param [context] {Object} Template context object</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">   * @param callback {Function} Callback function which accepts following arguments:</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">   *    {Object} err Error object,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">   *    {String} rendered Rendered text</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">  renderFile: function (path, context, callback) {</td></tr><tr class="hit"> <td class="line">129</td><td class="hits">10</td><td class="source">    if ('function' === typeof context) {</td></tr><tr class="hit"> <td class="line">130</td><td class="hits">1</td><td class="source">      callback = context;</td></tr><tr class="hit"> <td class="line">131</td><td class="hits">1</td><td class="source">      context = null;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">134</td><td class="hits">10</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">135</td><td class="hits">10</td><td class="source">    var partials = this.getPartials();</td></tr><tr class="hit"> <td class="line">136</td><td class="hits">10</td><td class="source">    var path_ = this.getViewPath(path);</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">138</td><td class="hits">10</td><td class="source">    if (this.contexts[path]) {</td></tr><tr class="hit"> <td class="line">139</td><td class="hits">1</td><td class="source">      context = extend({}, this.contexts[path], context);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">142</td><td class="hits">10</td><td class="source">    if (this.cache &amp;&amp; this.cache[path_]) {</td></tr><tr class="hit"> <td class="line">143</td><td class="hits">1</td><td class="source">      callback(null, this.render(this.cache[path_], context, partials));</td></tr><tr class="hit"> <td class="line">144</td><td class="hits">1</td><td class="source">      return;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">147</td><td class="hits">9</td><td class="source">    fs.readFile(path_, 'utf8', function (err, templateString) {</td></tr><tr class="hit"> <td class="line">148</td><td class="hits">9</td><td class="source">      if (err) {</td></tr><tr class="hit"> <td class="line">149</td><td class="hits">1</td><td class="source">        callback(err, '');</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">151</td><td class="hits">8</td><td class="source">        if (self.cache) {</td></tr><tr class="hit"> <td class="line">152</td><td class="hits">2</td><td class="source">          self.cache[path_] = templateString;</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"> <td class="line">154</td><td class="hits">8</td><td class="source">        callback(null, self.render(templateString, context, partials));</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">   * Set a layout view.</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">   * @param name {String|Object} Name of the layout of name/layout pair hash object</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">   * @param [layout] {Array} Array of partials' name for the layout</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">  setLayout: function (name, layout) {</td></tr><tr class="hit"> <td class="line">169</td><td class="hits">2</td><td class="source">    this.layout = this.layout || {};</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    function layoutToStr(arr) {</td></tr><tr class="hit"> <td class="line">171</td><td class="hits">2</td><td class="source">      var str = '';</td></tr><tr class="hit"> <td class="line">172</td><td class="hits">2</td><td class="source">      arr.forEach(function (l) {</td></tr><tr class="hit"> <td class="line">173</td><td class="hits">7</td><td class="source">        str += '{{&gt; ' + l + '}}\n';</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"> <td class="line">175</td><td class="hits">2</td><td class="source">      return str;</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">178</td><td class="hits">2</td><td class="source">    if (typeof name === 'string') {</td></tr><tr class="hit"> <td class="line">179</td><td class="hits">1</td><td class="source">      this.layout[name] = layoutToStr(layout);</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">181</td><td class="hits">1</td><td class="source">      Object.keys(name).forEach(function (n) {</td></tr><tr class="hit"> <td class="line">182</td><td class="hits">1</td><td class="source">        this.layout[n] = layoutToStr(name[n]);</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">      }, this);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">185</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">   * Render a layout with optional context.</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">   * @param layoutName {String} Name of the layout</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">   * @param [context] {Object} Optional context</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">   * @returns {String} Rendered result</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">  renderLayout: function (layoutName, context) {</td></tr><tr class="hit"> <td class="line">198</td><td class="hits">2</td><td class="source">    var layoutStr = this.layout[layoutName];</td></tr><tr class="hit"> <td class="line">199</td><td class="hits">2</td><td class="source">    if (!layoutStr) {</td></tr><tr class="miss"> <td class="line">200</td><td class="hits">0</td><td class="source">      throw new Error('Layout not exists');</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">202</td><td class="hits">2</td><td class="source">    if (this.contexts) {</td></tr><tr class="hit"> <td class="line">203</td><td class="hits">2</td><td class="source">      context = extend({}, this.contexts[layoutName], context);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">205</td><td class="hits">2</td><td class="source">    return this.render(layoutStr, context, this.getPartials());</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">   * Register a template partial</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">   * @param name {String} Name of your partial or path to the partial file if `templateString` is not provided</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">   * @param [templateString] {String} Template text</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">   * @param [namespace] {String} Optional namespace of the partial</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">  registerPartial: function (name, templateString, namespace) {</td></tr><tr class="hit"> <td class="line">218</td><td class="hits">121</td><td class="source">    var name_ = name;</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">220</td><td class="hits">121</td><td class="source">    if (namespace) {</td></tr><tr class="hit"> <td class="line">221</td><td class="hits">7</td><td class="source">      name_ = namespace + ':' + name;</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">224</td><td class="hits">121</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">225</td><td class="hits">121</td><td class="source">    var minify;</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">    // try to get minify function for current partial type when caching is enabled</td></tr><tr class="hit"> <td class="line">227</td><td class="hits">121</td><td class="source">    if (this.cache &amp;&amp; this.minify) {</td></tr><tr class="hit"> <td class="line">228</td><td class="hits">4</td><td class="source">      var ext = Path.extname(name);</td></tr><tr class="hit"> <td class="line">229</td><td class="hits">4</td><td class="source">      if (this.minify.hasOwnProperty(ext)) {</td></tr><tr class="hit"> <td class="line">230</td><td class="hits">1</td><td class="source">        minify = this.minify[ext];</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">234</td><td class="hits">121</td><td class="source">    if (!templateString) {</td></tr><tr class="hit"> <td class="line">235</td><td class="hits">112</td><td class="source">      var path_ = this.getViewPath(name_);</td></tr><tr class="hit"> <td class="line">236</td><td class="hits">112</td><td class="source">      templateString = fs.readFileSync(path_, 'utf8');</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">239</td><td class="hits">121</td><td class="source">    if (minify) {</td></tr><tr class="hit"> <td class="line">240</td><td class="hits">1</td><td class="source">      templateString = minify(templateString);</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">242</td><td class="hits">121</td><td class="source">    templateString = self.wrapPartial(name, templateString);</td></tr><tr class="hit"> <td class="line">243</td><td class="hits">121</td><td class="source">    self.partials[name_] = templateString;</td></tr><tr class="hit"> <td class="line">244</td><td class="hits">121</td><td class="source">    self.partialsEncoded[name_] = encodeURIComponent(templateString);</td></tr><tr class="hit"> <td class="line">245</td><td class="hits">121</td><td class="source">    self.partialsString = JSON.stringify(self.partialsEncoded);</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">   * Get partial object. Reload partials if caching is not enabled.</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">  getPartials: function () {</td></tr><tr class="hit"> <td class="line">256</td><td class="hits">12</td><td class="source">    if (!this.cache) {</td></tr><tr class="hit"> <td class="line">257</td><td class="hits">8</td><td class="source">      this.registerPartialDir();</td></tr><tr class="hit"> <td class="line">258</td><td class="hits">8</td><td class="source">      Object.keys(this.rootViewPaths).forEach(function (namespace) {</td></tr><tr class="hit"> <td class="line">259</td><td class="hits">1</td><td class="source">        this.registerPartialDir('', namespace);</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">      }, this);</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">262</td><td class="hits">12</td><td class="source">    return this.partials;</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">   * Set namespaced view path, register partials under the path with namespace.</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">   * @param pathNamespace {String} Namespace of the path</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">   * @param viewPath {String} Directory path</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">  setViewPath: function (pathNamespace, viewPath) {</td></tr><tr class="hit"> <td class="line">275</td><td class="hits">1</td><td class="source">    this.rootViewPaths[pathNamespace] = viewPath;</td></tr><tr class="hit"> <td class="line">276</td><td class="hits">1</td><td class="source">    this.registerPartialDir('', pathNamespace);</td></tr><tr class="hit"> <td class="line">277</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">   * Get absolute path of the view.</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">   * @param path {String} Relative path</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">   * @returns {String}</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">  getViewPath: function (path) {</td></tr><tr class="hit"> <td class="line">289</td><td class="hits">122</td><td class="source">    if ((Path.sep || '/') === path[0]) {</td></tr><tr class="hit"> <td class="line">290</td><td class="hits">3</td><td class="source">      return path;</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">292</td><td class="hits">119</td><td class="source">    var path_ = this.viewPaths[path];</td></tr><tr class="hit"> <td class="line">293</td><td class="hits">119</td><td class="source">    if (!path_) {</td></tr><tr class="hit"> <td class="line">294</td><td class="hits">6</td><td class="source">      path_ = path.split(':');</td></tr><tr class="hit"> <td class="line">295</td><td class="hits">6</td><td class="source">      if (1 === path_.length) {</td></tr><tr class="hit"> <td class="line">296</td><td class="hits">5</td><td class="source">        path_ = Path.join(this.rootViewPath, path);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"> <td class="line">298</td><td class="hits">1</td><td class="source">        path_ = Path.join(this.rootViewPaths[path_[0]], path_[1]);</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">301</td><td class="hits">119</td><td class="source">    return path_;</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">   * Set the url of script loader. Now only support head.js.</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">   * @param url {String} Url to loader script</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">  setScriptLoaderUrl: function (url) {</td></tr><tr class="hit"> <td class="line">312</td><td class="hits">1</td><td class="source">    this.scriptLoaderUrl = url;</td></tr><tr class="hit"> <td class="line">313</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">   * Registry script partial with given script names</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">   * @param partialName {String} Name of the script partial</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">   * @param scripts {Array} Names of script add to this partial</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">   * @param onLoad {Function} Script on load function</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">  registerScriptPartial: function (partialName, scripts, onLoad) {</td></tr><tr class="hit"> <td class="line">327</td><td class="hits">2</td><td class="source">    var scriptStr = ['&lt;script src=&quot;', this.scriptLoaderUrl, '&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;\n'].join('');</td></tr><tr class="hit"> <td class="line">328</td><td class="hits">2</td><td class="source">    scriptStr += '&lt;script type=&quot;text/javascript&quot;&gt;\n';</td></tr><tr class="hit"> <td class="line">329</td><td class="hits">2</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">330</td><td class="hits">2</td><td class="source">    scriptStr += 'head.js(';</td></tr><tr class="hit"> <td class="line">331</td><td class="hits">2</td><td class="source">    var lastIdx = scripts.length - 1;</td></tr><tr class="hit"> <td class="line">332</td><td class="hits">2</td><td class="source">    scripts.forEach(function (scriptName, idx) {</td></tr><tr class="hit"> <td class="line">333</td><td class="hits">3</td><td class="source">      var url = self.scripts[scriptName];</td></tr><tr class="hit"> <td class="line">334</td><td class="hits">3</td><td class="source">      scriptStr += &quot;'&quot; + url + &quot;'&quot;;</td></tr><tr class="hit"> <td class="line">335</td><td class="hits">3</td><td class="source">      if (idx &lt; lastIdx) {</td></tr><tr class="hit"> <td class="line">336</td><td class="hits">1</td><td class="source">        scriptStr += ', ';</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">340</td><td class="hits">2</td><td class="source">    if (typeof onLoad === 'function') {</td></tr><tr class="hit"> <td class="line">341</td><td class="hits">1</td><td class="source">      scriptStr += ', ' + onLoad.toString();</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">343</td><td class="hits">2</td><td class="source">    scriptStr += ');\n&lt;/script&gt;';</td></tr><tr class="hit"> <td class="line">344</td><td class="hits">2</td><td class="source">    var pName = partialName.split(':');</td></tr><tr class="hit"> <td class="line">345</td><td class="hits">2</td><td class="source">    if (pName.length === 2) {</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">      // partial has namespace</td></tr><tr class="hit"> <td class="line">347</td><td class="hits">1</td><td class="source">      this.registerPartial(pName[1], scriptStr, pName[0]);</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">349</td><td class="hits">1</td><td class="source">      this.registerPartial(partialName, scriptStr);</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">351</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">   * Store script name/url pair to view.</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">   * @param urls {Object|String} Name and url hash or name of the url</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">   * @param [url] {String} Optional url string if &quot;urls&quot; is string</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">   * @returns {Object}</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">   * @public</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">  setScriptUrl: function (urls, url) {</td></tr><tr class="hit"> <td class="line">364</td><td class="hits">3</td><td class="source">    var self = this;</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">    function _set(name, url) {</td></tr><tr class="hit"> <td class="line">367</td><td class="hits">3</td><td class="source">      self.scripts = self.scripts || {};</td></tr><tr class="hit"> <td class="line">368</td><td class="hits">3</td><td class="source">      self.scripts[name] = url;</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">371</td><td class="hits">3</td><td class="source">    if (typeof urls === 'string') {</td></tr><tr class="hit"> <td class="line">372</td><td class="hits">2</td><td class="source">      _set(urls, url);</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"> <td class="line">374</td><td class="hits">1</td><td class="source">      Object.keys(urls).forEach(function (name) {</td></tr><tr class="hit"> <td class="line">375</td><td class="hits">1</td><td class="source">        _set(name, urls[name]);</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">378</td><td class="hits">3</td><td class="source">    return this;</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">   * Recursively register all template partial files under the directory.</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">   * @param [relativeDir] {String} Relative path of the directory</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">   * @param [namespace] {String} Namespace of the path</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">  registerPartialDir: function (relativeDir, namespace) {</td></tr><tr class="hit"> <td class="line">390</td><td class="hits">38</td><td class="source">    relativeDir = relativeDir || '';</td></tr><tr class="hit"> <td class="line">391</td><td class="hits">38</td><td class="source">    var self = this;</td></tr><tr class="hit"> <td class="line">392</td><td class="hits">38</td><td class="source">    var rootViewPath = (namespace ? this.rootViewPaths[namespace] : this.rootViewPath) || this.rootViewPath;</td></tr><tr class="hit"> <td class="line">393</td><td class="hits">38</td><td class="source">    var exts = this.exts;</td></tr><tr class="hit"> <td class="line">394</td><td class="hits">38</td><td class="source">    var dir = Path.join(rootViewPath, relativeDir);</td></tr><tr class="hit"> <td class="line">395</td><td class="hits">38</td><td class="source">    var files = fs.readdirSync(dir);</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">397</td><td class="hits">38</td><td class="source">    files.forEach(function (file) {</td></tr><tr class="hit"> <td class="line">398</td><td class="hits">171</td><td class="source">      var absolutePath = Path.join(rootViewPath, relativeDir, file);</td></tr><tr class="hit"> <td class="line">399</td><td class="hits">171</td><td class="source">      var relativeFilePath = Path.join(relativeDir, file);</td></tr><tr class="hit"> <td class="line">400</td><td class="hits">171</td><td class="source">      var stats = fs.statSync(absolutePath);</td></tr><tr class="hit"> <td class="line">401</td><td class="hits">171</td><td class="source">      if (stats.isFile() &amp;&amp; exts.indexOf(Path.extname(absolutePath)) &gt; -1) {</td></tr><tr class="hit"> <td class="line">402</td><td class="hits">112</td><td class="source">        var viewName = (namespace ? namespace + ':' : '') + relativeFilePath;</td></tr><tr class="hit"> <td class="line">403</td><td class="hits">112</td><td class="source">        self.viewPaths[viewName] = absolutePath;</td></tr><tr class="hit"> <td class="line">404</td><td class="hits">112</td><td class="source">        self.registerPartial(relativeFilePath, null, namespace);</td></tr><tr class="hit"> <td class="line">405</td><td class="hits">59</td><td class="source">      } else if (stats.isDirectory()) {</td></tr><tr class="hit"> <td class="line">406</td><td class="hits">21</td><td class="source">        self.registerPartialDir(relativeFilePath, namespace);</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">   * Wrap partial with script tag if it's a javascript partial</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">   * @param filename {String} Name of the partial</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">   * @param str {String} Content of the partial</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">   * @returns {String}</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">  wrapPartial: function (filename, str) {</td></tr><tr class="hit"> <td class="line">421</td><td class="hits">121</td><td class="source">    var type = Path.extname(filename);</td></tr><tr class="hit"> <td class="line">422</td><td class="hits">121</td><td class="source">    if ('.js' === type) {</td></tr><tr class="hit"> <td class="line">423</td><td class="hits">79</td><td class="source">      str = '&lt;script type=&quot;text/javascript&quot;&gt;' + str + '&lt;/script&gt;';</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"> <td class="line">425</td><td class="hits">121</td><td class="source">    return str;</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source"> * Expose View.</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source"> * @type {Function}</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"> <td class="line">434</td><td class="hits">1</td><td class="source">exports.View = View;</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div></body></html>
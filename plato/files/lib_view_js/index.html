<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>lib/view.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">68.93</p>
    </div>
    <div class="span6">
      <h2 class="header">Estimated # Bugs  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">2.95</p>
    </div>
  </div>
  <div class="row">
    <div class="span6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">54.67</p>
    </div>
    <div class="span6">
      <h2 class="header">SLOC/LSLOC <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">326 / 189</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">/**
 * Module dependencies
 */

var Path = require('path');
var fs = require('fs');
var Base = require('./base').Base;
var extend = require('./util').extend;

/**
 * Factory function to create a view instance
 * 
 * @param {Object} engine Template engine like hogan.js
 * @param {Object} options View options:
 *  {
 *    rootViewPath: '/path/to/your/view/templates', // The default absolute path of your template files
 *    cache: true, // cache or not
 *    context: {x: 1}, // the default context of the view instance,
 *    exts: ['.mu', '.js'] // template file extentions,
 *  }
 * @constructor
 * @public
 */
function View(engine, options) {
  if (typeof engine.render !== 'function' && typeof engine.compile !== 'function') {
    throw new Error('Your template engine must implements at least one of these functions: `render` and `compile`.');
  }
  this.engine = engine;
  this.options = options || {};
  this.options.exts = this.options.exts || ['.mu', '.js'];
  if (this.options.rootViewPath) {
    recursiveRegisterPartials(this);
  }
  if (this.options.cache) {
    this.fileCache = {};
    this.clientCodeString = exports.getClientCodeString();
  }
  if (this.options.context) {
    this.context = this.options.context;
  }
  if (this.options.layout) {
    this.setLayout(this.options.layout);
  }
  if (typeof this.engine.compile === 'function') {
    this.hasCompiler = true;
  }
  if (this.options.minify) {
    this.minify = this.options.minify;
  }
}

View.prototype = {

  /**
   * Render template with given context
   * 
   * @param {String} templateString Template text string
   * @param {Object} context Template context object
   */
  render: function(templateString, context) {
    if (this.hasCompiler) {
      return this.engine.compile(templateString).render(extend({}, this.context, context), this.getPartials());
    } else {
      return this.engine.render(templateString, extend({}, this.context, context), this.getPartials());
    }
  },

  /**
   * Read the template from file and render it
   * 
   * @param {String} path Path to the template file
   * @param {Object} context Template context object
   * @param {Function} callback Callback function which accepts following arguments:
   *    {Object} err Error object,
   *    {String} rendered Rendered text
   */
  renderFile: function(path, context, callback) {
    var path_ = path;
    var namespacedPath = path.split(':');
    if (namespacedPath.length === 2) {
      path_ = Path.join(this.viewPaths[namespacedPath[0]], namespacedPath[1]);
    } else if (this.options.rootViewPath) {
      path_ = Path.join(this.options.rootViewPath, path_);
    }
    var self = this;
    if (this.options.cache && this.fileCache[path_]) {
      callback(null, this.render(this.fileCache[path_], context));
      return;
    }
    fs.readFile(path_, 'utf8', function(err, templateString) {
      if (err) {
        console.trace(err.stack || err);
      }
      callback(err, self.render(templateString, context));
      if (self.options.cache) {
        self.fileCache[path_] = templateString;
      }
    });
  },

  /**
   * Register a template partial
   *
   * @param {String} name Name of your partial or path to the partial file if `templateString` is not provided
   * @param {String} templateString Template text
   * @param {String} namespace Namespace of the partial
   */
  registerPartial: function(name, templateString, namespace) {
    this.partials = this.partials || {};
    this.partialsEncoded = this.partialsEncoded || {};

    var name_ = name;
    if (namespace) {
      name_ = namespace + ':' + name;
    }

    var self = this;
    var minify;
    // try to get minify function for current partial type when caching is enabled
    if (this.options.cache && this.minify) {
      var ext = extname(name);
      if (this.minify.hasOwnProperty(ext)) {
        minify = this.options.minify[ext];
      }
    }

    var reg = function (tplStr) {
      // minify the content if we have minify function
      if (minify) {
        tplStr = minify(tplStr);
      }
      // try to wrap the partial code
      tplStr = wrapPartial(name, tplStr);
      self.partials[name_] = tplStr;
      self.partialsEncoded[name_] = encodeURIComponent(tplStr);
      self.partialsString = JSON.stringify(self.partialsEncoded);
    };

    if ('undefined' === typeof templateString) {
      var path_ = name;
      if (namespace) {
        path_ = Path.join(self.viewPaths[namespace], path_);
      } else {
        path_ = Path.join(self.options.rootViewPath, path_);
      }

      fs.readFile(path_, 'utf8', function(err, fileContent) {
        if (err) {
          console.error('Failed to register partial file:');
          console.error(err.stack || err);
          return;
        }
        reg(fileContent);
      });
    } else {
      reg(templateString);
    }
  },

  getPartials: function() {
    if (!this.options.cache) {
      recursiveRegisterPartials(this);
    }
    return this.partials;
  },

  getClientCodeString:function () {
    var str = '';
    if (this.options.cache) {
      str = this.clientCodeString;
    } else {
      str = exports.getClientCodeString();
    }
    return str;
  },

  setViewPath:function (pathNamespace, viewPath) {
    this.viewPaths = this.viewPaths || {};
    this.viewPaths[pathNamespace] = viewPath;
    recursiveRegisterPartials(this, '', pathNamespace);
    return this;
  },

  addViewPath:function (pathNamespace, viewPath) {
    console.log('Warning: `addViewPath` is deprecated, use `setViewPath` instead.');
    return this.setViewPath(pathNamespace, viewPath);
  },

  setScriptLoaderUrl:function (url) {
    this.scriptLoaderUrl = url;
  },

  /**
   * Registry script partial with given script names
   *
   * @param partialName
   * @param {Array} scripts
   * @param {Function} onLoad
   */
  registerScriptPartial:function (partialName, scripts, onLoad) {
    var scriptStr = ['<script src="', this.scriptLoaderUrl,'" type="text/javascript"></script>\n'].join('');
    scriptStr += '<script type="text/javascript">\n';
    var self = this;
    scriptStr += 'head.js(';
    var lastIdx = scripts.length - 1;
    scripts.forEach(function (scriptName, idx) {
      var url = self.scripts[scriptName];
      scriptStr += "'" + url + "'";
      if (idx < lastIdx) {
        scriptStr += ', ';
      }
    });

    if (typeof onLoad === 'function') {
      scriptStr += ', ' + onLoad.toString();
    }
    scriptStr += ');\n</script>';
    var pName = partialName.split(':');
    if (pName.length === 2) {
      // partial has namespace
      this.registerPartial(pName[1], scriptStr, pName[0]);
    } else {
      this.registerPartial(partialName, scriptStr);
    }
  },

  setScriptUrl:function (urls, url) {
    var self = this;
    function _set(name, url) {
          self.scripts = self.scripts || {};
          self.scripts[name] = url;
        }
    if (typeof urls === 'string') {
      _set(urls, url);
    } else {
      Object.keys(urls).forEach(function (name) {
        _set(name, urls[name]);
      });
    }
    return this;
  },

  setLayout:function (name, layout) {
    this.layout = this.layout || {};
    function layoutToStr(arr) {
      var str = '';
      arr.forEach(function (l) {
        str += '{{> ' + l + '}}\n';
      });
      return str;
    }
    if (typeof name === 'string') {
      this.layout[name] = layoutToStr(layout);
    } else {
      Object.keys(name).forEach(function (n) {
        this.layout[n] = layoutToStr(name[n]);
      }, this);
    }
  },

  renderLayout:function (layoutName, context) {
    var layoutStr = this.layout[layoutName];
    if (!layoutStr) {
      throw new Error('Layout not exists');
    }
    if (this.layoutContexts) {
      context = extend(this.layoutContexts[layoutName], context);
    }
    return this.render(layoutStr, context);
  },

  setLayoutContext: function (layoutName, context) {
    this.layoutContexts = this.layoutContexts || {};
    this.layoutContexts[layoutName] = context;
  }
};


function recursiveRegisterPartials(viewInstance, relativePath, namespace) {
  var rootViewPath;
  if (namespace) {
    rootViewPath = viewInstance.viewPaths[namespace];
  } else {
    rootViewPath = viewInstance.options.rootViewPath;
  }
  var exts = viewInstance.options.exts;
  var dir = Path.join(rootViewPath, relativePath);
  fs.readdir(dir, function(err, files) {
    if (err) {
      console.trace(err.stack || err);
      throw err;
    }
    files.forEach(function(file) {
      var absolutePath = Path.join(rootViewPath, relativePath, file);
      var relativeFilePath = Path.join(relativePath, file);
      fs.stat(absolutePath, function(err, stats) {
        if (err) {
          console.trace(err.stack || err);
          throw err;
        }
        if (stats.isFile() && exts.indexOf(Path.extname(absolutePath)) > -1) {
          viewInstance.registerPartial(relativeFilePath, undefined, namespace);
        }
        if (stats.isDirectory()) {
          recursiveRegisterPartials(viewInstance, relativeFilePath, namespace);
        }
      });
    });
  });
}

function getClientCodeString() {
  var codeStr = fs.readFileSync(Path.join(__dirname, 'model.js'), 'utf8');
  return codeStr;
}

function extname(filename) {
  return Path.extname(filename).slice(1);
}

function wrapPartial(filename, str) {
  var type = extname(filename);
  if ('js' === type) {
    str = '<script type="text/javascript">' + str + '</script>';
  }
  return str;
}

exports.View = View;
exports.getClientCodeString = getClientCodeString;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
<script>
  $('[rel=popover]').popover();
</script>

</body>
</html>
